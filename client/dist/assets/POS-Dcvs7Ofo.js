import{r as i,j as e,$ as zt,a0 as It,ax as Et,a1 as Dt,a2 as Ft,I as At,A as yt,s as Ee,m as Rt,n as Ct,u as Ot,R as vt,ay as Mt,az as St,aA as Nt,aB as Pt,K as st,x as Ze,aC as $t,aD as Bt,ag as et,aE as _t,a4 as Wt,aF as lt,aG as Lt,aH as Vt,a9 as qt,aI as Ht,C as Je,q as Gt,aJ as Jt,aK as Qt,aL as Yt,i as Ke,aM as Ut,W as Kt,ab as Xt,Y as Zt,aN as ea,aO as ta,H as aa,X as dt,aP as ct,aQ as Ge,aR as pt,ad as oa,ai as na,a5 as ra}from"./vendor-BMIwBeBI.js";import{M as wt,S as Z,P as ia,a as sa,b as la,c as Ie,d as Me,B as N,T as ie,I as mt,e as xt,H as da,f as ca,g as pa,C as ma,h as xa,i as fa,R as _e,Q as ua,j as ft}from"./POS.styles-CI0-ztUL.js";import{u as tt,a as ga,o as ha,p as ba,q as ut,r as gt,t as ja,v as ya,m as Ca,w as Xe,x as va}from"./index-C7JoirjO.js";import{S as Sa,T as Na}from"./SalesHistoryModal--5quYzhC.js";import"./AlertModal-D3Gk2GaP.js";import{C as wa}from"./ConfirmationModal-BxjGWYJU.js";import"./scanner-vendor-DfxRpMWJ.js";import"./pdf-vendor-qNamXCRA.js";const ht=n=>Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),bt=Ee.button`
  display: flex; align-items: center; justify-content: center;
  width: 42px; height: 42px;
  border: 1px solid ${n=>n.$active?"#3b82f6":"#cbd5e1"};
  background-color: ${n=>n.$active?"#eff6ff":"#fff"};
  color: ${n=>n.$active?"#3b82f6":"#64748b"};
  border-radius: 8px; cursor: pointer; transition: all 0.2s;

  &:hover { border-color: #3b82f6; color: #3b82f6; }
`,Ta=({isOpen:n,imageSrc:w,onClose:r})=>!n||!w?null:e.jsx(Ie,{onClick:r,children:e.jsxs(Rt.div,{initial:{scale:.9,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.9,opacity:0},onClick:W=>W.stopPropagation(),style:{position:"relative",maxWidth:"95%",maxHeight:"90vh"},children:[e.jsx("button",{onClick:r,style:{position:"absolute",top:-15,right:-15,background:"white",width:32,height:32,borderRadius:"50%",border:"none",cursor:"pointer",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:10,color:"#ef4444"},children:e.jsx(Ct,{})}),e.jsx("img",{src:w,alt:"Vista Ampliada",style:{maxWidth:"100%",maxHeight:"85vh",borderRadius:"12px",boxShadow:"0 20px 25px rgba(0,0,0,0.2)",background:"white",objectFit:"contain"}})]})});function ka({products:n=[],searchTerm:w,setSearchTerm:r,onProductClick:W,cartItems:O=[],reservedStock:J,inputRef:c,searchType:Q="description",setSearchType:v=()=>{}}){const[S,_]=i.useState({isOpen:!1,imageUrl:null}),Y=i.useMemo(()=>{const s=new Map;for(const p of O){const y=p.id_producto||p.id;s.set(y,(s.get(y)||0)+Number(p.quantity||0))}return s},[O]),oe=i.useMemo(()=>{const s=(w||"").toLowerCase().trim();return n.filter(y=>{const x=V=>V?String(V).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase():"",L=x(s);if(!L)return!0;if(Q==="code"){const V=x(y.codigo),u=x(y.codigo_barras);return V.startsWith(L)||u.startsWith(L)}else{const V=x(y.nombre),u=x(y.descripcion),q=x(y.codigo);return V.includes(L)||u.includes(L)||q.includes(L)}}).slice(0,100)},[n,w,Q]),j=i.useMemo(()=>{const s=(w||"").toLowerCase().trim();return s?n.filter(p=>{const y=(p.nombre||"").toLowerCase(),x=String(p.codigo||"").toLowerCase();return y.includes(s)||x.includes(s)}).length:n.length},[n,w]);return e.jsxs(wt,{children:[e.jsxs("div",{style:{display:"flex",gap:"8px",marginBottom:"1rem",alignItems:"center"},children:[e.jsx(Z,{ref:c,placeholder:Q==="code"?"Escribe código...":"Buscar producto...",value:w,onChange:s=>r(s.target.value)}),e.jsx(bt,{$active:Q==="description",onClick:()=>{var s;v("description"),(s=c.current)==null||s.focus()},title:"Buscar por Nombre",children:e.jsx(zt,{size:16})}),e.jsx(bt,{$active:Q==="code",onClick:()=>{var s;v("code"),(s=c.current)==null||s.focus()},title:"Buscar por Código",children:e.jsx(It,{size:18})})]}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"8px",padding:"0 4px",fontSize:"0.85rem",color:"#64748b"},children:[e.jsxs("span",{children:[e.jsx(Et,{color:"#3b82f6"})," ",oe.length," mostrados"]}),e.jsxs("span",{children:["Total: ",j]})]}),e.jsx(ia,{children:oe.map(s=>{const p=s.id_producto||s.id,y=Y.get(p)||0,x=(J==null?void 0:J.get(p))||0,L=Math.max(0,Number(s.existencia||0)-y-x),V=L<=0;return e.jsxs(sa,{onClick:()=>!V&&W(s),outOfStock:V,title:s.nombre,children:[e.jsx(la,{lowstock:L<5&&!V,outOfStock:V,children:V?"Agotado":`Stock: ${L}`}),e.jsxs("div",{className:"image-placeholder",style:{position:"relative",height:160,background:"#f8fafc",display:"flex",alignItems:"center",justifyContent:"center",borderBottom:"1px solid #f1f5f9",overflow:"hidden"},children:[s.imagen&&e.jsx("div",{className:"eye-icon",onClick:u=>{u.stopPropagation(),_({isOpen:!0,imageUrl:s.imagen})},style:{position:"absolute",top:10,left:10,zIndex:20,background:"white",borderRadius:"50%",width:32,height:32,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",cursor:"pointer",transition:"transform 0.2s"},title:"Ver imagen",children:e.jsx(Dt,{size:14,color:"#64748b"})}),s.imagen?e.jsx("img",{src:s.imagen,alt:s.nombre,loading:"lazy",style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}}):e.jsx(Ft,{className:"no-image-icon",size:40,color:"#e2e8f0"})]}),e.jsxs("div",{className:"info",style:{padding:"12px",flex:1,display:"flex",flexDirection:"column",gap:"4px"},children:[e.jsx("div",{className:"product-name",style:{fontWeight:600,fontSize:"0.88rem",color:"#1e293b",lineHeight:"1.25",height:"3.8rem",overflow:"hidden",display:"-webkit-box",WebkitLineClamp:3,WebkitBoxOrient:"vertical"},children:s.nombre}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:"bold",color:"#334155",marginBottom:"4px"},children:s.codigo||"S/C"}),(Number(s.mayorista)>0||Number(s.mayoreo)>0)&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"#10b981",display:"flex",alignItems:"center",gap:"4px",marginTop:"auto",marginBottom:"1px"},children:[e.jsx(At,{size:10})," May: C$ ",ht(s.mayorista||s.mayoreo)]}),e.jsxs("div",{className:"price",style:{fontWeight:800,color:"#2563eb",fontSize:"1.05rem",marginTop:Number(s.mayorista)>0||Number(s.mayoreo)>0?0:"auto"},children:["C$ ",ht(s.precio_venta||s.precio)]})]})]},p)})}),e.jsx(yt,{children:S.isOpen&&e.jsx(Ta,{isOpen:!0,imageSrc:S.imageUrl,onClose:()=>_({isOpen:!1,imageUrl:null})})})]})}const za=vt.memo(()=>e.jsx("style",{children:`
  /* Importar League Spartan */
  @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600;800;900&display=swap');

  @media print {
    body { visibility: hidden; margin: 0; padding: 0; }
    .print-area, .print-area * { visibility: visible !important; }
    .print-area {
      position: absolute !important; left: 0 !important; top: 0 !important;
      z-index: 999999 !important; margin: 0 !important; padding: 0 !important;
    }
    .no-print { display: none !important; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-shadow: none !important; text-shadow: none !important; }
  }
  `})),Ia=Ee.div`
  font-family: 'League Spartan', 'Consolas', sans-serif; color: #000; background: #fff;
  width: 310px; margin: 0 auto; padding: 12px 6px;
  box-shadow: 0 0 10px rgba(0,0,0,.08); border: 1px solid #eee; border-radius: 8px;

  /* Encabezado */
  .brand { text-align: center; border-bottom: 3px solid #000; padding-bottom: 12px; margin-bottom: 15px; }
  .brand img { max-width: 120px; display: block; margin: 0 auto 10px; }
  .brand h2 { margin: 0 0 6px; font-size: 1.6rem; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; }
  .brand p { margin: 3px 0; font-size: 1rem; font-weight: 700; }

  /* Secciones y Filas */
  .section { margin-bottom: 18px; border-bottom: 1px dashed #000; padding-bottom: 12px; }
  .section:last-child { border-bottom: none; }
  .section-title { font-weight: 900; text-align: center; text-transform: uppercase; font-size: 1.2rem; margin-bottom: 10px; text-decoration: underline; letter-spacing: 0.5px; }
  
  .row { display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 6px; align-items: baseline; font-weight: 600; }
  .row.big { font-size: 1.5rem; font-weight: 900; margin-top: 12px; border-top: 3px solid #000; padding-top: 8px; }
  .row.sub { font-size: 0.9rem; color: #333; font-style: italic; padding-left: 10px; margin-bottom: 4px; font-weight: 400; }
  .row.alert { background: #eee; padding: 8px; font-weight: 900; text-align: center; justify-content: center; gap: 10px; border: 2px solid #000; margin-top: 12px; font-size: 1.4rem; }

  /* Tablas simples */
  table { width: 100%; border-collapse: collapse; font-size: 1rem; margin-top: 8px; }
  th { border-bottom: 2px solid #000; text-align: left; font-weight: 900; padding: 4px 2px; }
  td { border-bottom: 1px dashed #ccc; padding: 4px 2px; }
  .text-right { text-align: right; }

  /* Firma */
  .signature { margin-top: 60px; text-align: center; page-break-inside: avoid; }
  .signature-line { border-top: 2px solid #000; width: 80%; margin: 0 auto 8px; }
  .signature p { font-size: 1.1rem; font-weight: 700; }

  @media print {
    &.print-80 {
      width: 80mm !important; 
      font-family: 'League Spartan', sans-serif !important; 
      padding: 0px !important; border: none !important; box-shadow: none !important;
    }
  }
`,Ea=(n,w)=>{var W,O;if(!n)return"N/A";if((W=n.pagoDetalles)!=null&&W.clienteNombre)return n.pagoDetalles.clienteNombre;const r=((O=n.pagoDetalles)==null?void 0:O.clienteId)||n.clientId;if(r&&(w==null?void 0:w.length)>0){const J=w.find(c=>String(c.id_cliente)===String(r));if(J)return J.nombre}return null},jt=({currentUser:n,isCajaOpen:w,session:r,onOpenCaja:W,onCloseCaja:O,onClose:J,isAdmin:c,showConfirmation:Q,showAlert:v,initialTasaDolar:S,clients:_=[]})=>{var T,Ae;const[Y,oe]=i.useState(""),[j,s]=i.useState(S||36.6),[p,y]=i.useState(""),[x,L]=i.useState(!1),V=Ot(),u=(n==null?void 0:n.id_usuario)||(n==null?void 0:n.id);let q=(T=r==null?void 0:r.openedBy)==null?void 0:T.name;!q&&(r!=null&&r.openedBy)&&typeof r.openedBy=="string"&&(q=r.openedBy),q||(q=(r==null?void 0:r.userId)===u?(n==null?void 0:n.nombre_usuario)||(n==null?void 0:n.username):"Usuario"),q||(q="Caja General");const ee=c||(r==null?void 0:r.userId)===u||((Ae=r==null?void 0:r.openedBy)==null?void 0:Ae.id)===u,k=i.useMemo(()=>Array.isArray(r==null?void 0:r.transactions)?r.transactions:[],[r]),{cajaInicial:l,netCordobas:ve,netDolares:be,efectivoEsperado:je,efectivoEsperadoCordobas:we,efectivoEsperadoDolares:De,ventasContado:Qe,devoluciones:Ye,cancelaciones:Fe,entradas:z,salidas:I,abonos:K,totalTarjeta:Se,totalTransferencia:te,totalCredito:de,totalNoEfectivo:X,sumDevolucionesCancelaciones:ae,totalVentasDia:ne,tasaRef:Te,totalHidden:ce}=i.useMemo(()=>{const g=Number((r==null?void 0:r.initialAmount)||0),M=Number((r==null?void 0:r.tasaDolar)||S||36.6),R={ventasContado:[],devoluciones:[],cancelaciones:[],entradas:[],salidas:[],abonos:[]};let h=0,me=0,re=0,f=0,U=0,ue=0,G=0,Re=0;for(const le of k){const P=((le==null?void 0:le.type)||"").toLowerCase();let A=(le==null?void 0:le.pagoDetalles)||{};if(typeof A=="string")try{A=JSON.parse(A)}catch{A={}}(!A||typeof A!="object")&&(A={});let We=Number(A.ingresoCaja!==void 0?A.ingresoCaja:le.amount||0),Ne=Number(A.totalVenta!==void 0?A.totalVenta:le.amount||0);(P==="salida"||P.includes("devolucion"))&&(We=-Math.abs(We),Ne=-Math.abs(Ne));const ge=We,ye={...le,pagoDetalles:A,displayAmount:Ne};if(P.includes("abono")){const Ve=Ea(ye,_);Ve&&(ye.resolvedClientName=Ve)}const $e=Number(A.tarjeta||0),Be=Number(A.transferencia||0),Le=Number(A.credito||0);P.startsWith("venta")||P.includes("abono")||P.includes("pedido")?(re+=$e,f+=Be,U+=Le):P==="ajuste"&&(A.target==="tarjeta"&&(re+=Number(le.amount||0)),A.target==="credito"&&(U+=Number(le.amount||0)),A.target==="transferencia"&&(f+=Number(le.amount||0))),P.startsWith("venta")||P==="venta_contado"||P==="venta_mixta"||P==="venta_credito"?A.efectivo!==void 0||A.dolares!==void 0?(h+=Number(A.efectivo||0)-Number(A.cambio||0),me+=Number(A.dolares||0)):h+=ge-$e-Be-Le:P.includes("abono")?A.dolares!==void 0?(me+=Number(A.dolares||0),h+=Number(A.efectivo||0)):h+=ge:P==="entrada"?h+=Math.abs(ge):P==="salida"?h-=Math.abs(ge):P.includes("devolucion")?h+=ge:P==="ajuste"?(A.target==="efectivo"&&(h+=ge,A.hidden&&(Re+=ge)),A.target==="dolares"&&(me+=ge)):h+=ge-$e-Be,P.startsWith("venta")||P.includes("abono")||P==="entrada"?ue+=Math.abs(Ne):P==="ajuste"&&(ue+=Ne),P.startsWith("venta")?R.ventasContado.push(ye):P.includes("devolucion")?(R.devoluciones.push(ye),G+=Math.abs(Ne)):P.includes("cancelacion")?(R.cancelaciones.push(ye),G+=Math.abs(Ne)):P==="entrada"?R.entradas.push(ye):P==="salida"?R.salidas.push(ye):P.includes("abono")&&R.abonos.push(ye)}const Oe=g+h+me*M;return{cajaInicial:g,netCordobas:h,netDolares:me,efectivoEsperado:Oe,efectivoEsperadoCordobas:g+h,efectivoEsperadoDolares:me,ventasContado:R.ventasContado,devoluciones:R.devoluciones,cancelaciones:R.cancelaciones,entradas:R.entradas,salidas:R.salidas,abonos:R.abonos,totalTarjeta:re,totalTransferencia:f,totalCredito:U,totalNoEfectivo:re+f+U,sumDevolucionesCancelaciones:G,totalVentasDia:ue,tasaRef:M,totalHidden:Re}},[k,r,S,_]),H=Number(p||0)-je;r!=null&&r.openedAt&&new Date(r.openedAt);const pe=()=>{const g=parseFloat(Y||0);if(isNaN(g)||g<0)return v({title:"Inválido",message:"Monto inicial >= 0"});W(g,Number(j||36.6))},Pe=()=>{if(isNaN(parseFloat(p)))return v({title:"Requerido",message:"Ingrese el monto contado físico."});L(!0)},F=vt.useCallback(()=>{const g=document.getElementById("print-wrapper-caja");if(!g)return;const M=g.outerHTML,R=`
        @charset "UTF-8";
        @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;600;800;900&display=swap');
        @page { size: 80mm auto; margin: 0; }
        html, body {
          background: #fff; margin: 0 !important; padding: 0 !important;
          -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
          color: #000 !important; font-family: 'League Spartan', sans-serif !important;
        }
        #print-wrapper-caja, #print-wrapper-caja * {
          color: #000 !important; font-weight: 700 !important;
          text-shadow: none !important; box-shadow: none !important;
          visibility: visible !important;
        }
        #print-wrapper-caja {
          width: 80mm !important; padding: 0 !important; border: none !important;
        }
        .brand h2 { font-size: 20pt !important; letter-spacing: 2px !important; margin-bottom: 5px !important; }
        .section-title { font-size: 14pt !important; margin-bottom: 12px !important; border-bottom: 2px solid #000 !important; }
        .row { font-size: 12pt !important; margin-bottom: 6px !important; font-weight: 900 !important; }
        .row.big { font-size: 16pt !important; margin-top: 15px !important; border-top: 4px solid #000 !important; }
        .row.alert { font-size: 18pt !important; padding: 10px !important; border: 4px solid #000 !important; }
        .text-right { text-align: right !important; }
        
        @media print {
          * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
      `,h=window.open("","_blank","width=500,height=600");h&&(h.document.write(`<html><head><title>Cierre Caja</title><style>${R}</style></head><body>${M}</body></html>`),h.document.close(),h.focus(),h.onload=function(){setTimeout(()=>{h.print()},300)},h.onafterprint=()=>{try{h.close()}catch{}})},[]),se=()=>{F(),setTimeout(()=>{O(Number(p))},800)},E=g=>`C$${Number(g||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,fe=g=>`$${Number(g||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs(Ie,{className:"no-print",children:[e.jsx(za,{}),e.jsxs(Me,{style:{maxWidth:x?450:760,padding:x?0:"1.5rem",background:"#f8f9fa"},children:[!x&&e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12},children:[e.jsx("h2",{style:{margin:0},children:"Gestión de Caja"}),e.jsx(N,{$cancel:!0,onClick:J,style:{borderRadius:"50%",width:32,height:32,padding:0},children:"✕"})]}),w?x?e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",maxHeight:"90vh"},children:[e.jsxs("div",{style:{padding:"15px 20px",background:"#343a40",color:"#fff",display:"flex",justifyContent:"space-between",alignItems:"center",borderRadius:"8px 8px 0 0"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:"1.2rem",fontWeight:"800",letterSpacing:"0.5px"},children:"REPORTAR CIERRE DE CAJA"}),e.jsx("p",{style:{margin:0,fontSize:"0.9rem",opacity:.8},children:new Date().toLocaleString("es-NI")})]}),e.jsxs(N,{$cancel:!0,onClick:()=>L(!1),style:{padding:"8px 15px",fontSize:"0.9rem",background:"rgba(255,255,255,0.2)",border:"none"},children:[e.jsx(St,{})," Volver / Editar"]})]}),e.jsxs("div",{style:{flex:1,overflowY:"auto",background:"#f8f9fa",padding:"20px"},children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:15,marginBottom:20},children:[e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:"4px solid #007bff"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Ventas Totales"}),e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:"#333"},children:E(ne)})]}),e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:"4px solid #28a745"},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Efectivo Real"}),e.jsx("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:"#28a745"},children:E(p)})]}),e.jsxs("div",{style:{background:"#fff",padding:15,borderRadius:8,boxShadow:"0 2px 5px rgba(0,0,0,0.05)",borderLeft:`4px solid ${H<0?"#dc3545":"#ffc107"}`},children:[e.jsx("div",{style:{fontSize:"0.8rem",color:"#666",textTransform:"uppercase"},children:"Diferencia"}),e.jsxs("div",{style:{fontSize:"1.5rem",fontWeight:"800",color:H!==0?H<0?"#dc3545":"#e0a800":"#28a745"},children:[H>0?"+":"",E(H)]})]})]}),e.jsxs("div",{style:{background:"#fff",padding:20,borderRadius:8,boxShadow:"0 2px 10px rgba(0,0,0,0.05)",marginBottom:20},children:[e.jsx("h4",{style:{margin:"0 0 15px",borderBottom:"1px solid #eee",paddingBottom:10},children:"Arqueo Detallado"}),e.jsx("table",{style:{width:"100%",borderCollapse:"collapse"},children:e.jsxs("tbody",{children:[e.jsxs("tr",{style:{borderBottom:"1px solid #f1f1f1"},children:[e.jsx("td",{style:{padding:10},children:"Fondo Inicial"}),e.jsx("td",{className:"text-right",style:{padding:10,fontWeight:"bold"},children:E(l)})]}),e.jsx("tr",{style:{background:"#f8f9fa"},children:e.jsx("td",{colSpan:"2",style:{padding:"8px 10px",fontSize:"0.85rem",fontWeight:"bold",color:"#007bff"},children:"RESUMEN DE INGRESOS"})}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem"},children:"(+) Total Ingresos (Ventas + Abonos)"}),e.jsx("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem"},children:E(ne)})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem",color:"#dc3545"},children:"(-) Tarjetas / Transf / Crédito"}),e.jsxs("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem",color:"#dc3545"},children:["- ",E(X)]})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"4px 10px 4px 20px",fontSize:"0.9rem",color:"#dc3545"},children:"(-) Salidas de Efectivo"}),e.jsxs("td",{className:"text-right",style:{padding:"4px 10px",fontSize:"0.9rem",color:"#dc3545"},children:["- ",E(I.reduce((g,M)=>g+Math.abs(M.displayAmount||0),0))]})]}),e.jsxs("tr",{style:{borderBottom:"1px solid #f1f1f1",background:"#e8f5e9"},children:[e.jsx("td",{style:{padding:10,fontWeight:"bold",fontSize:"1.1rem"},children:"Esperado en Caja"}),e.jsx("td",{className:"text-right",style:{padding:10,fontWeight:"bold",fontSize:"1.1rem",color:"#146c43"},children:E(je)})]})]})})]}),(K.length>0||I.length>0)&&e.jsxs("div",{style:{background:"#fff",padding:20,borderRadius:8,boxShadow:"0 2px 10px rgba(0,0,0,0.05)"},children:[e.jsx("h4",{style:{margin:"0 0 15px",borderBottom:"1px solid #eee",paddingBottom:10},children:"Detalle de Movimientos"}),K.length>0&&e.jsxs("div",{style:{marginBottom:15},children:[e.jsx("h5",{style:{color:"#007bff",margin:"0 0 5px"},children:"Abonos Recibidos"}),K.map((g,M)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsxs("div",{children:[e.jsx("strong",{children:g.resolvedClientName||"Cliente General"}),e.jsx("div",{style:{fontSize:"0.8rem",color:"#666"},children:g.note||"Abono de cuenta"})]}),e.jsxs("div",{style:{fontWeight:"bold",color:"#28a745"},children:["+ ",E(g.amount)]})]},M))]}),I.length>0&&e.jsxs("div",{children:[e.jsx("h5",{style:{color:"#dc3545",margin:"0 0 5px"},children:"Salidas de Caja"}),I.map((g,M)=>e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px dashed #eee"},children:[e.jsx("div",{children:g.note||"Salida Varia"}),e.jsx("div",{style:{fontWeight:"bold",color:"#dc3545"},children:E(Math.abs(g.amount))})]},M))]})]})]}),e.jsx("div",{style:{display:"none"},children:e.jsxs(Ia,{id:"print-wrapper-caja",className:"print-80",children:[e.jsxs("div",{className:"brand",children:[e.jsx("img",{src:"/icons/logo.png",alt:"Logo",style:{filter:"grayscale(100%) contrast(150%)"}}),e.jsx("h2",{children:"CIERRE DE CAJA"}),e.jsx("p",{children:"Multirepuestos RG"}),e.jsx("p",{children:new Date().toLocaleString("es-NI")}),e.jsxs("p",{children:["Cajero: ",q]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"1. TOTAL INGRESOS (VENTAS + ABONOS)"}),e.jsxs("div",{className:"row big",children:[e.jsx("span",{children:"TOTAL GLOBAL:"}),e.jsx("span",{children:E(ne)})]}),e.jsx("div",{className:"row sub",children:"(Ventas Contado + Crédito + Abonos + Ajustes)"})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"2. DESGLOSE NO EFECTIVO"}),Se>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Tarjetas:"}),e.jsx("span",{children:E(Se)})]}),te>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Transf.:"}),e.jsx("span",{children:E(te)})]}),de>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Créditos:"}),e.jsx("span",{children:E(de)})]}),e.jsxs("div",{className:"row",style:{borderTop:"1px dashed #000"},children:[e.jsx("span",{children:"TOTAL NO EFECTIVO:"}),e.jsx("span",{children:E(X)})]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"3. FLUJO EFECTIVO (RESUMEN)"}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"Fondo Inicial:"}),e.jsx("span",{children:E(l)})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(+) Ingresos Totales:"}),e.jsx("span",{children:E(ne)})]}),e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) No Efectivo:"}),e.jsxs("span",{children:["-",E(X)]})]}),Math.abs(I.reduce((g,M)=>g+Math.abs(M.displayAmount||0),0))>0&&e.jsxs("div",{className:"row",children:[e.jsx("span",{children:"(-) Salidas:"}),e.jsxs("span",{children:["-",E(I.reduce((g,M)=>g+Math.abs(M.displayAmount||0),0))]})]})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"4. ARQUEO FINAL"}),e.jsxs("div",{className:"row big",children:[e.jsx("span",{children:"EFECTIVO ESPERADO:"}),e.jsx("span",{children:E(je)})]}),e.jsxs("div",{className:"row sub",children:["(",E(we)," + ",fe(De),")"]}),e.jsxs("div",{className:"row",style:{marginTop:8,paddingTop:4,borderTop:"1px dashed #ccc"},children:[e.jsx("span",{children:"EFECTIVO REAL:"}),e.jsx("span",{children:E(p)})]}),e.jsxs("div",{className:"row alert",style:{color:"#000",borderColor:"#000"},children:[e.jsx("span",{children:"DIFERENCIA:"}),e.jsxs("span",{children:[H>0?"+":"",E(H)]})]}),e.jsx("div",{style:{textAlign:"center",fontSize:"0.75rem",fontWeight:"bold",marginTop:2},children:Math.abs(H)<.5?"(CAJA CUADRADA)":H>0?"(SOBRANTE)":"(FALTANTE)"})]}),e.jsxs("div",{className:"section",children:[e.jsx("div",{className:"section-title",children:"5. DETALLE DE MOVIMIENTOS"}),e.jsx("table",{style:{marginTop:0},children:e.jsxs("tbody",{children:[K.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem"},children:"--- ABONOS Y CREDITOS ---"})}),K.map((g,M)=>e.jsxs("tr",{children:[e.jsxs("td",{style:{fontSize:"0.9rem"},children:[g.resolvedClientName||g.note||"Abono"," ",e.jsx("br",{}),e.jsxs("span",{style:{fontSize:"0.75rem",color:"#555"},children:["#",g.id]})]}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:E(g.amount)})]},"a"+M))]}),I.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem",paddingTop:8},children:"--- SALIDAS DE EFECTIVO ---"})}),I.map((g,M)=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.9rem"},children:g.note||"Salida Varia"}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:E(Math.abs(g.amount))})]},"s"+M))]}),z.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("tr",{children:e.jsx("td",{colSpan:"2",style:{fontWeight:"900",background:"#f8f9fa",fontSize:"0.9rem",paddingTop:8},children:"--- ENTRADAS DE EFECTIVO ---"})}),z.map((g,M)=>e.jsxs("tr",{children:[e.jsx("td",{style:{fontSize:"0.9rem"},children:g.note||"Entrada Varia"}),e.jsx("td",{className:"text-right",style:{fontSize:"0.9rem"},children:E(g.amount)})]},"e"+M))]})]})}),K.length===0&&I.length===0&&z.length===0&&e.jsx("div",{style:{textAlign:"center",fontStyle:"italic",fontSize:"0.8rem",padding:5},children:"Sin movimientos extra"})]}),e.jsxs("div",{className:"signature",children:[e.jsx("div",{className:"signature-line"}),e.jsx("p",{children:"Firma Responsable"})]})]})}),e.jsxs("div",{style:{padding:"20px",background:"#fff",borderTop:"1px solid #ccc",display:"flex",gap:10,justifyContent:"flex-end"},children:[e.jsx(N,{$cancel:!0,onClick:()=>L(!1),children:"Seguir Editando"}),e.jsxs(N,{primary:!0,style:{padding:"12px 24px",fontSize:"1rem",display:"flex",alignItems:"center",gap:8},onClick:se,disabled:!ee,children:[e.jsx(Nt,{})," IMPRIMIR Y CERRAR CAJA"]})]}),!ee&&e.jsx("div",{style:{padding:5,textAlign:"center",color:"red",fontSize:"0.8rem"},children:"Solo el Admin o quien abrió puede cerrar."})]}):e.jsxs("div",{children:[e.jsx("h3",{style:{color:"#dc3545",borderBottom:"2px solid #dc3545",paddingBottom:10},children:"Arqueo y Cierre"}),e.jsx("div",{style:{background:"#e9ecef",padding:10,borderRadius:6,marginBottom:15},children:e.jsxs(ie,{style:{fontSize:"1.1rem"},children:[e.jsxs("span",{children:[e.jsx(Pt,{})," Abrió:"]}),e.jsx("strong",{children:q})]})}),e.jsxs("div",{style:{marginTop:8,padding:"15px",backgroundColor:"#f8f9fa",borderRadius:6,border:"1px dashed #ced4da"},children:[e.jsx("div",{style:{fontWeight:"800",marginBottom:10,fontSize:"1.2rem",color:"#495057"},children:"Efectivo a Tener:"}),e.jsxs(ie,{style:{fontSize:"1.3rem"},children:[e.jsx("span",{children:"Córdobas:"}),e.jsxs("strong",{style:{color:"#198754"},children:["C$ ",Number(we).toLocaleString()]})]}),e.jsxs(ie,{style:{fontSize:"1.3rem"},children:[e.jsx("span",{children:"Dólares:"}),e.jsxs("strong",{style:{color:"#198754"},children:["$ ",Number(De).toLocaleString()]})]}),e.jsxs(ie,{$bold:!0,style:{marginTop:10,borderTop:"2px solid #ccc",paddingTop:10,fontSize:"1.5rem"},children:[e.jsx("span",{children:"TOTAL (C$):"}),e.jsx("span",{children:E(je)})]})]}),e.jsx("label",{style:{display:"block",marginTop:20,fontWeight:800,fontSize:"1.3rem"},children:"Monto Contado Físico (C$)"}),e.jsx(Z,{type:"number",step:"0.01",value:p,onChange:g=>y(g.target.value),autoFocus:!0,placeholder:"Total Billetes + Monedas",style:{fontSize:"1.5rem",padding:"12px",height:"auto"}}),p&&e.jsxs(ie,{$bold:!0,style:{marginTop:15,color:H!==0?"#dc3545":"#28a745",fontSize:"1.8rem",padding:"10px",background:H!==0?"#fff5f5":"#f0fff4",borderRadius:8,border:`2px solid ${H!==0?"#dc3545":"#28a745"}`},children:[e.jsx("span",{children:"Diferencia:"}),e.jsx("span",{children:E(H)})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginTop:20},children:[e.jsx(N,{primary:!0,style:{flex:1},onClick:Pe,disabled:!ee||!p,children:"Ver Reporte"}),e.jsx(N,{$cancel:!0,onClick:J,children:"Cancelar"})]})]}):e.jsxs("div",{style:{padding:x?"1rem":0},children:[e.jsxs("h3",{style:{color:"#28a745",borderBottom:"2px solid #28a745",paddingBottom:10},children:[e.jsx(Mt,{})," Abrir Caja"]}),e.jsxs("div",{style:{display:"grid",gap:12},children:[e.jsx("label",{style:{fontWeight:600},children:"Monto Inicial (C$)"}),e.jsx(Z,{type:"number",step:"0.01",value:Y,onChange:g=>oe(g.target.value),autoFocus:!0}),e.jsx("label",{style:{fontWeight:600},children:"Tasa del Dólar"}),e.jsx(Z,{type:"number",step:"0.01",value:j,onChange:g=>s(g.target.value)})]}),e.jsxs("div",{style:{marginTop:20,display:"flex",gap:10},children:[e.jsx(N,{primary:!0,style:{flex:1},onClick:pe,children:"Abrir Caja"}),e.jsx(N,{onClick:()=>V("/dashboard"),children:"Ir al Dashboard"})]})]})]})]})},qe=n=>{const w=parseFloat(n);return Number.isNaN(w)||Math.abs(w)<.001?0:w},Da=({total:n=0,tasaDolar:w=1,onClose:r,onFinishSale:W,clientes:O=[],users:J=[],showAlert:c,initialClientId:Q="0",cartSnapshot:v=[],currentUserId:S=void 0,orderSubtotal:_=void 0,orderDiscountAmount:Y=void 0})=>{const[oe,j]=i.useState("0.00"),[s,p]=i.useState("0.00"),[y,x]=i.useState("0.00"),[L,V]=i.useState("0.00"),[u,q]=i.useState(""),[ee,k]=i.useState(""),[l,ve]=i.useState("contado"),[be,je]=i.useState(Q??"0"),[we,De]=i.useState(!1),[Qe,Ye]=i.useState(!1),Fe=i.useMemo(()=>{const f=parseInt(be,10);return Number.isNaN(f)?0:f},[be]),z=Fe!==0,I=i.useMemo(()=>qe(oe),[oe]),K=i.useMemo(()=>qe(s),[s]),Se=i.useMemo(()=>qe(y),[y]),te=i.useMemo(()=>qe(L),[L]),de=i.useMemo(()=>Se*Number(w||1),[Se,w]),X=i.useMemo(()=>I+K+te+de,[I,K,te,de]),ae=i.useMemo(()=>K>.01,[K]),ne=i.useMemo(()=>Number(n)-X,[n,X]),Te=i.useMemo(()=>l==="credito"&&z&&ne>.01?ne:(X>=Number(n)-1e-4,0),[l,z,ne,X,n]),ce=i.useMemo(()=>{const f=qe(ne);return f<=.01||l==="credito"&&z?0:f},[ne,l,z]),H=i.useMemo(()=>Math.max(0,-ne),[ne]),pe=i.useMemo(()=>Te>.01?X>.01?"mixto":"credito_total":"contado",[Te,X]),Pe=i.useMemo(()=>{if(ce>.01)return"PAGO INCOMPLETO";if((pe==="mixto"||pe==="credito_total")&&!z)return"CLIENTE NO SELECCIONADO";switch(pe){case"mixto":return"PAGO MIXTO (Contado + Crédito)";case"credito_total":return"CRÉDITO TOTAL";default:return"CONTADO"}},[pe,ce,z]),F=i.useMemo(()=>l==="credito"&&!z,[l,z]),se=i.useMemo(()=>we||ce>.01||(pe==="mixto"||pe==="credito_total")&&!z||ae&&!u.trim()||te>.01&&!ee.trim(),[we,ce,pe,z,ae,u,te,ee]),E=i.useMemo(()=>Array.isArray(v)?v.map(({raw:f,costo:U,existencia:ue,...G})=>({id:G.id||G.id_producto,nombre:G.nombre??G.descripcion??G.producto??"",quantity:Number(G.quantity||0),precio:Number(G.precio_venta??G.precio??0)})).filter(f=>f.quantity>0):[],[v]),fe=i.useMemo(()=>typeof _=="number"?Number(_):E.reduce((f,U)=>f+Number(U.precio||0)*Number(U.quantity||0),0),[_,E]);i.useMemo(()=>{if(typeof Y=="number")return Number(Y);const f=Number(fe)-Number(n);return f>0?f:0},[Y,fe,n]),i.useEffect(()=>{l==="contado"&&X===0&&Number(n)>0&&j(Number(n).toFixed(2)),l==="credito"&&!z&&je("0")},[l,n]);const T=i.useCallback(f=>{const U=String(f.target.value);je(U),(parseInt(U,10)||0)!==0&&(ve("contado"),X<Number(n)&&X===0&&j(Number(n).toFixed(2)))},[X,n]),Ae=i.useCallback(()=>{ve("contado");const f=K+te+de,U=Math.max(0,Number(n)-f);j(Number(U).toFixed(2))},[K,te,de,n]),g=i.useCallback(()=>{if(!z){c==null||c({title:"Cliente Requerido",message:"Debe seleccionar un cliente para habilitar la opción de Crédito.",type:"error"});return}ve("credito"),j("0.00"),p("0.00"),x("0.00"),V("0.00"),q(""),k("")},[z,c]),M=i.useCallback(()=>{j(Number(n).toFixed(2)),p("0.00"),x("0.00"),V("0.00"),q(""),k(""),ve("contado")},[n]),R=({efectivo:f,tarjeta:U,transferencia:ue,dolaresLocal:G,credito:Re})=>{const Oe=f+U+ue+G>.01;return Re&&Oe?"mixto":Re&&!Oe?"credito_total":"contado"},h=async f=>{if(!z||Fe===0){c==null||c({title:"Cliente Requerido",message:"No puedes vender sin seleccionar un cliente. Por favor selecciona uno.",type:"error"});return}if((pe==="credito_total"||pe==="mixto")&&Fe===0){c==null||c({title:"Cliente Requerido",message:"Debe seleccionar un cliente para ventas a crédito o mixtas.",type:"error"});return}if(ce>.01){c==null||c({title:"Pago Incompleto",message:`Faltan C$${ce.toFixed(2)} para completar la venta.`,type:"warning"});return}if(ae&&!u.trim()){c==null||c({title:"Dato Requerido",message:"Ingrese el número de referencia para el pago con tarjeta.",type:"warning"});return}if(te>.01&&!ee.trim()){c==null||c({title:"Dato Requerido",message:"Ingrese el número de referencia para la transferencia.",type:"warning"});return}if(we)return;De(!0);const U=Math.max(0,I+de-H),ue={totalVenta:Number(n),efectivo:I,tarjeta:K,transferencia:te,dolares:Se,tasaDolarAlMomento:Number(w),referenciaTarjeta:u.trim(),referenciaTransferencia:ee.trim(),credito:Te,clienteId:Fe,tipoVenta:R({efectivo:I,tarjeta:K,transferencia:te,dolaresLocal:de,credito:l==="credito"}),cambio:Number(H),ingresoCaja:Number(U),shouldPrintNow:f};try{typeof W=="function"&&await W(ue),r==null||r()}catch(G){c==null||c({title:"Error",message:(G==null?void 0:G.message)||"No se pudo completar la venta.",type:"error"})}finally{De(!1)}},me=z?ce>.01?"#dc3545":H>.01?"#28a745":"#17a2b8":"#dc3545",re=z?ce>.01?`¡FALTA CUBRIR! C$${ce.toFixed(2)}`:H>.01?`CAMBIO A ENTREGAR: C$${H.toFixed(2)}`:"BALANCE PERFECTO":"¡SELECCIONA UN CLIENTE!";return e.jsx(Ie,{children:e.jsxs(Me,{style:{maxWidth:"950px",width:"96%",maxHeight:"90vh",overflow:"hidden",borderRadius:16,backgroundColor:"#f8f9fa",boxShadow:"0 25px 50px -12px rgba(0, 0, 0, 0.25)"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"2px solid #e9ecef",paddingBottom:15,marginBottom:20},children:[e.jsxs("h2",{style:{margin:0,color:"#1e293b",fontSize:"1.5rem",fontWeight:800},children:[e.jsx(st,{style:{marginRight:"0.5rem",color:"#007bff"}})," PROCESAR PAGO"]}),e.jsx(N,{$cancel:!0,onClick:r,style:{borderRadius:"50%",width:40,height:40,padding:0,fontSize:"1.2rem",backgroundColor:"#fee2e2",color:"#ef4444",borderColor:"transparent"},children:e.jsx(Ze,{})})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"5fr 4fr",gap:"2rem",height:"calc(90vh - 140px)"},children:[e.jsxs("div",{style:{paddingRight:10,borderRight:"1px solid #e2e8f0",overflowY:"auto",paddingBottom:10},children:[e.jsxs("div",{style:{padding:20,border:"1px solid #e2e8f0",borderRadius:12,backgroundColor:"#fff",marginBottom:20,boxShadow:"0 1px 3px rgba(0,0,0,0.05)"},children:[e.jsxs("h4",{style:{marginTop:0,color:"#334155",fontSize:"1rem",fontWeight:700,textTransform:"uppercase",marginBottom:15},children:[e.jsx($t,{style:{marginRight:6}})," Tipo de Venta"]}),e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:20},children:[e.jsx(N,{onClick:Ae,style:{flex:1,padding:"10px 0",backgroundColor:l==="contado"?"#0ea5e9":"#f1f5f9",color:l==="contado"?"#fff":"#475569",border:"none",borderRadius:8,fontWeight:"700",boxShadow:l==="contado"?"0 4px 6px -1px rgba(14, 165, 233, 0.4)":"none"},children:"CONTADO"}),e.jsx(N,{onClick:g,disabled:!z,style:{flex:1,padding:"10px 0",backgroundColor:l==="credito"?"#f59e0b":"#f1f5f9",color:l==="credito"?"#fff":"#475569",border:"none",borderRadius:8,fontWeight:"700",boxShadow:l==="credito"?"0 4px 6px -1px rgba(245, 158, 11, 0.4)":"none",opacity:z?1:.5},children:"CRÉDITO"})]}),e.jsxs("label",{style:{display:"block",fontWeight:"700",marginBottom:8,color:"#475569",fontSize:"0.9rem"},children:[e.jsx(Bt,{})," Seleccionar Cliente ",e.jsx("span",{style:{color:"#ef4444"},children:"* (Obligatorio)"})]}),e.jsxs(Z,{as:"select",value:be,onChange:T,style:{height:42,padding:"0 12px",width:"100%",fontSize:"1rem",border:z?"2px solid #22c55e":"2px solid #ef4444",backgroundColor:z?"#f0fdf4":"#fef2f2",borderRadius:8},children:[e.jsx("option",{value:"0",children:"-- Seleccionar Cliente --"}),(O||[]).map(f=>e.jsxs("option",{value:f.id_cliente??f.id,children:[f.nombre,Number(f.saldo_pendiente||0)>0?` (Deuda: C$${Number(f.saldo_pendiente).toFixed(2)})`:""]},f.id_cliente??f.id))]}),!z&&e.jsxs("p",{style:{color:"#ef4444",margin:"8px 0 0",fontSize:"0.85rem",fontWeight:"600"},children:[e.jsx(Ze,{style:{marginRight:4}})," No puedes vender sin seleccionar un cliente."]})]}),e.jsxs("div",{style:{padding:20,border:"1px solid #e2e8f0",borderRadius:12,backgroundColor:"#fff",boxShadow:"0 1px 3px rgba(0,0,0,0.05)"},children:[e.jsx("h4",{style:{marginTop:0,color:"#334155",fontSize:"1rem",fontWeight:700,textTransform:"uppercase",borderBottom:"1px solid #f1f5f9",paddingBottom:10,marginBottom:15},children:"Desglose de Pago (C$)"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"15px"},children:[e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(et,{})," Efectivo"]}),e.jsx(Z,{type:"number",step:"0.01",value:oe,onChange:f=>j(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:F})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(_t,{})," Dólares"]}),e.jsx(Z,{type:"number",step:"0.01",value:y,onChange:f=>x(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:F})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(st,{})," Tarjeta"]}),e.jsx(Z,{type:"number",step:"0.01",value:s,onChange:f=>p(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:F})]}),e.jsxs("div",{children:[e.jsxs("label",{style:{display:"block",fontWeight:"600",fontSize:"0.85rem",marginBottom:6,color:"#64748b"},children:[e.jsx(St,{})," Transferencia"]}),e.jsx(Z,{type:"number",step:"0.01",value:L,onChange:f=>V(f.target.value),style:{width:"100%",height:38,fontSize:"1rem",borderRadius:8,border:"1px solid #cbd5e1"},disabled:F})]})]}),l==="credito"&&e.jsxs("div",{style:{marginTop:15,padding:12,backgroundColor:"#fff7ed",borderRadius:8,border:"1px dashed #f97316"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",marginBottom:4,color:"#c2410c"},children:[e.jsx(Wt,{})," CRÉDITO GENERADO"]}),e.jsxs("div",{style:{fontSize:"1.2rem",color:"#ea580c",fontWeight:800},children:["C$ ",Te.toFixed(2)]})]}),ae&&e.jsxs("div",{style:{marginTop:15,padding:12,border:"1px solid #fcd34d",borderRadius:8,backgroundColor:"#fffbeb"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",color:"#b45309",marginBottom:6},children:[e.jsx(lt,{})," Nº Referencia Tarjeta ",e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),e.jsx(Z,{type:"text",placeholder:"Ej: 1234",value:u,onChange:f=>q(f.target.value),style:{width:"100%",height:36,fontSize:"0.95rem"}})]}),te>.01&&e.jsxs("div",{style:{marginTop:15,padding:12,border:"1px solid #bae6fd",borderRadius:8,backgroundColor:"#f0f9ff"},children:[e.jsxs("label",{style:{display:"block",fontWeight:"700",fontSize:"0.85rem",color:"#0369a1",marginBottom:6},children:[e.jsx(lt,{})," Nº Referencia Transferencia ",e.jsx("span",{style:{color:"#ef4444"},children:"*"})]}),e.jsx(Z,{type:"text",placeholder:"Ej: REF-5678",value:ee,onChange:f=>k(f.target.value),style:{width:"100%",height:36,fontSize:"0.95rem"}})]}),l==="contado"&&e.jsxs(N,{info:!0,onClick:M,style:{width:"100%",padding:"12px 0",marginTop:20,backgroundColor:"#e0f2fe",color:"#0284c7",border:"1px dashed #0ea5e9",fontSize:"0.95rem",fontWeight:600},children:[e.jsx(Lt,{})," Rellenar con Efectivo (Total: C$ ",Number(n).toFixed(2),")"]})]})]}),e.jsxs("div",{style:{paddingLeft:10,display:"flex",flexDirection:"column",justifyContent:"space-between",paddingBottom:10},children:[e.jsxs("div",{children:[e.jsxs(mt,{style:{marginBottom:15,padding:20,backgroundColor:"#f0f9ff",border:"none",borderRadius:12,boxShadow:"inset 0 2px 4px rgba(0,0,0,0.05)"},children:[e.jsxs(ie,{$bold:!0,style:{fontSize:"1.8rem",color:"#0f172a",marginBottom:5},children:[e.jsx("span",{style:{fontSize:"1rem",color:"#64748b",fontWeight:600},children:"TOTAL A PAGAR"}),e.jsxs("span",{children:["C$ ",Number(n).toFixed(2)]})]}),e.jsxs(ie,{style:{borderTop:"1px solid #cbd5e0",paddingTop:10,fontSize:"0.9rem",color:"#64748b"},children:[e.jsxs("span",{children:["Tasa USD: C$ ",Number(w).toFixed(2)]}),e.jsxs("span",{style:{color:"#0f172a",fontWeight:700},children:["$",(Number(n)/Number(w||1)).toFixed(2)," USD"]})]})]}),e.jsxs("div",{style:{padding:15,border:"1px solid #e2e8f0",borderRadius:12,marginBottom:15,backgroundColor:"#fff"},children:[e.jsxs(ie,{style:{color:"#64748b",fontSize:"0.95rem",marginBottom:8},children:[e.jsx("span",{children:"Pagado (Contado)"}),e.jsxs("span",{style:{fontWeight:"700",color:"#1e293b"},children:["C$ ",X.toFixed(2)]})]}),e.jsxs(ie,{style:{fontSize:"0.95rem"},children:[e.jsx("span",{children:"Estado"}),e.jsx("span",{style:{fontWeight:"700",color:Te>.01?"#f59e0b":z?"#22c55e":"#ef4444"},children:Pe})]})]}),e.jsxs(mt,{style:{marginBottom:10,padding:15,backgroundColor:me==="#dc3545"?"#fef2f2":me==="#28a745"?"#ecfccb":"#e0f2fe",color:me==="#dc3545"?"#ef4444":me==="#28a745"?"#4d7c0f":"#0369a1",fontWeight:"800",fontSize:"1.1rem",textAlign:"center",borderRadius:12,border:"none",boxShadow:"0 2px 4px rgba(0,0,0,0.05)"},children:[e.jsx(Vt,{style:{marginRight:8}})," ",re]})]}),e.jsxs("div",{style:{marginTop:"auto",display:"flex",flexDirection:"column",gap:"12px"},children:[e.jsxs(N,{type:"button",onClick:f=>{f.preventDefault(),h(!0)},disabled:se||!z,style:{width:"100%",padding:"16px 0",fontSize:"1.2rem",fontWeight:800,backgroundColor:se||!z?"#cbd5e1":"#2563eb",color:"white",border:"none",borderRadius:10,boxShadow:se||!z?"none":"0 4px 6px -1px rgba(37, 99, 235, 0.4)",transition:"all 0.2s"},children:[e.jsx(Nt,{style:{marginRight:8}})," PAGAR E IMPRIMIR"]}),e.jsxs(N,{type:"button",onClick:f=>{f.preventDefault(),h(!1)},disabled:se||!z,style:{width:"100%",padding:"12px 0",fontSize:"1rem",fontWeight:700,backgroundColor:"white",color:se||!z?"#cbd5e1":"#475569",border:se||!z?"1px solid #e2e8f0":"2px solid #cbd5e1",borderRadius:10,transition:"all 0.2s"},children:[e.jsx(qt,{style:{marginRight:8}})," Solo Guardar (Sin Ticket)"]})]})]})]})]})})},Fa=Gt`
  @media print {
    body { visibility: hidden; margin: 0; padding: 0; }
    .print-area, .print-area * { visibility: visible !important; }
    .print-area {
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      z-index: 999999 !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    .no-print { display: none !important; }
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      box-shadow: none !important;
      text-shadow: none !important;
    }
  }
`,Aa=Ee.div`
  font-family: 'Consolas','Courier New',monospace;
  color: #000;
  background: #fff;
  width: 310px;
  margin: 0 auto;
  padding: 12px 10px;
  box-shadow: 0 0 10px rgba(0,0,0,.08);
  border: 1px solid #eee;
  border-radius: 8px;

  &.compact { padding: 8px 6px; }

  /* Encabezado */
  .brand {
    text-align: center;
    border-bottom: 1px dashed #333;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  .brand h1 { margin: 6px 0 2px; font-size: 1.35rem; font-weight: 700; color: #0b72b9; line-height: 1.25; }
  .brand small { color: #555; display: block; margin: 3px 0; line-height: 1.35; white-space: normal; word-break: break-word; }

  /* Meta */
  .meta { font-size: .9rem; margin-bottom: 12px; border-bottom: 1px dashed #ccc; padding-bottom: 8px; }
  .meta p { margin: 2px 0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 4px 8px; font-weight: 400; }
  .meta-label { font-weight: 700; }
  .meta-value { font-weight: 400; }

  /* Tabla */
  table.items { width: 100%; border-collapse: collapse; font-size: .9rem; table-layout: fixed; }
  table.items th, table.items td { padding: 6px 4px; vertical-align: top; word-wrap: break-word; }
  table.items th { border-bottom: 2px solid #333; font-weight: 700; text-transform: uppercase; font-size: 0.75rem; color: #1e3a8a; }
  &.compact table.items th, &.compact table.items td { padding: 4px 2px; }
  .text-right { text-align: right; }
  .col-qty { width: 15%; text-align: center; }
  .col-unit { width: 25%; text-align: right; }
  .col-total { width: 25%; text-align: right; }
  table.items td:nth-child(2) { white-space: normal; text-align: left; }

  /* Totales */
  .totals { border-top: 2px solid #333; padding-top: 6px; margin-top: 12px; }
  .badge { display: inline-block; font-weight: 700; letter-spacing: .5px; padding: 6px 10px; border: 2px solid #0b72b9; border-radius: 4px; margin: 10px auto; text-align: center; color: #0b72b9; font-size: 0.8rem; }
  .thanks { text-align: center; font-size: .85rem; border-top: 1px dashed #333; padding-top: 10px; margin-top: 12px; color: #444; line-height: 1.4; }

  /* ====== A4 SPECIFIC LAYOUT ====== */
  &.print-a4 {
    .brand { display: flex; justify-content: space-between; align-items: flex-start; text-align: left; border-bottom: 3px solid #1e3a8a; margin-bottom: 2rem; padding-bottom: 1rem; }
    .brand-logo-container { width: 150px; }
    .brand-info { text-align: right; max-width: 60%; }
    .brand h1 { font-size: 20pt; color: #1e3a8a; margin-bottom: 5px; }
    .brand small { font-size: 9pt; color: #444; margin: 1px 0; }
    
    .meta { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border: 1px solid #ddd; padding: 15px; background: #f8fafc; border-radius: 6px; margin-bottom: 25px; }
    .meta-col { display: flex; flex-direction: column; gap: 5px; }
    .meta-title { font-weight: bold; text-transform: uppercase; color: #1e3a8a; border-bottom: 1px solid #ccc; padding-bottom: 4px; margin-bottom: 6px; font-size: 9pt; }
    .meta p { justify-content: flex-start; gap: 8px; border-bottom: none; width: 100%; display: grid; grid-template-columns: 100px 1fr; }
    
    table.items th { background: #f1f5f9; color: #334155; padding: 10px; border-bottom: 2px solid #cbd5e1; font-size: 9pt; }
    table.items td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-size: 10pt; color: #334155; }
    .col-qty { width: 10%; }
    .col-unit { width: 15%; }
    .col-total { width: 15%; }
    
    .totals { border-top: none; margin-top: 0; display: flex; justify-content: flex-end; padding-top: 20px; }
    .totals-box { width: 250px; }
    
    .thanks { border-top: none; margin-top: 50px; font-style: italic; color: #94a3b8; }
  }

  @media print {
    &.print-80 {
      width: 80mm !important; font-family: 'Consolas', monospace !important; padding: 6px 4px !important; border: none !important; box-shadow: none !important; font-size: 8pt;
    }
    &.print-a4 {
      width: 190mm !important; font-size: 10pt !important; padding: 0 !important; margin: 0 !important; border: none !important; box-shadow: none !important; max-height: 277mm !important; overflow: hidden !important; font-family: 'Inter', Helvetica, Arial, sans-serif !important;
    }
    &.compact { font-size: 7.5pt; }
  }
`,Ra=Ee.div`
  display: flex; flex-direction: column; gap: 12px;
`,Oa=Ee.img`
  width: 120px; max-width: 160px; height: auto; display: block; margin: 0 auto 6px; border-radius: 6px;
  &.a4-logo { margin: 0; max-width: 140px; }
`,Ma=Ee.span`
  display: inline-flex; align-items: center; gap: 6px; font-weight: 700; letter-spacing: .4px; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; background: #e8f4ff; color: #0b72b9; border: 1px solid #b9defc;
`,Pa=Ee.div`
  display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: .75rem;
`,$a=({cart:n=[],total:w=0,subtotal:r=0,discount:W=0,proformaFor:O="",onClose:J,currentUser:c,client:Q})=>{const{user:v}=typeof tt=="function"?tt():{user:null},{settings:S}=ga(),_=u=>(u==null?void 0:u.usuarioNombre)||(u==null?void 0:u.nombre_usuario)||(u==null?void 0:u.name)||(u==null?void 0:u.nombre)||(u==null?void 0:u.username)||null;let Y=null;try{Y=JSON.parse(localStorage.getItem("authUser")||"null")}catch{}const oe=_(c)||_(v)||_(Y)||"Cajero POS",j=(Q==null?void 0:Q.nombre)||"Consumidor Final",s=(Q==null?void 0:Q.cedula)||"",p=new Date().toLocaleString("es-NI"),y=u=>new Intl.NumberFormat("es-NI",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(u||0)),x={name:(S==null?void 0:S.empresa_nombre)||"Multirepuestos RG",ruc:(S==null?void 0:S.empresa_ruc)||"1211812770001E",phone:(S==null?void 0:S.empresa_telefono)||"84031936 / 84058142",address:(S==null?void 0:S.empresa_direccion)||"Del portón de la normal 75 varas al este. Juigalpa, Chontales.",slogan:(S==null?void 0:S.empresa_eslogan)||"Tu mejor opción en repuestos",logo:(S==null?void 0:S.empresa_logo_url)||new URL("/icons/logo.png",window.location.origin).toString()},L=i.useCallback((u="80")=>{const q=document.getElementById("print-wrapper-proforma");if(!q)return;const ee=q.outerHTML,k=`
      @charset "UTF-8";
      @page { size: ${u==="A4"?"A4 portrait":"80mm auto"}; margin: ${u==="A4"?"12mm":"0"}; }
      html, body {
        background: #fff; margin: 0 !important; padding: 0 !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color: #000 !important; font-family: ${u==="A4"?"'Inter', Helvetica, Arial, sans-serif":"'Consolas', monospace"};
      }
      
      #print-wrapper-proforma {
        box-shadow: none !important; border: none !important; margin: 0 !important;
        ${u==="A4"?"width: 100% !important; padding: 0 !important; font-size: 10pt !important;":"width: 80mm !important; padding: 6px 4px !important; font-size: 8pt !important;"}
      }

      ${u==="A4"?`
        #print-wrapper-proforma .brand { display: flex !important; justify-content: space-between !important; align-items: flex-start !important; text-align: left !important; border-bottom: 3px solid #1e3a8a !important; margin-bottom: 25px !important; padding-bottom: 15px !important; }
        #print-wrapper-proforma .brand-logo-container { width: 140px !important; order: 1 !important; }
        #print-wrapper-proforma .brand-info { flex: 1 !important; text-align: right !important; order: 2 !important; }
        #print-wrapper-proforma .brand h1 { font-size: 22pt !important; color: #1e3a8a !important; margin: 0 0 5px 0 !important; }
        #print-wrapper-proforma .brand small { display: block !important; font-size: 9pt !important; margin: 2px 0 !important; color: #334155 !important; }
        
        #print-wrapper-proforma .meta { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 30px !important; background: #f8fafc !important; border: 1px solid #e2e8f0 !important; padding: 15px !important; margin-bottom: 30px !important; border-radius: 8px !important; }
        #print-wrapper-proforma .meta p { display: grid !important; grid-template-columns: 100px 1fr !important; width: 100% !important; border-bottom: 1px dashed #e2e8f0 !important; padding-bottom: 4px !important; margin-bottom: 4px !important; }
        #print-wrapper-proforma .meta-title { font-weight: 800 !important; text-transform: uppercase !important; color: #1e3a8a !important; border-bottom: 2px solid #cbd5e1 !important; margin-bottom: 10px !important; padding-bottom: 5px !important; display: block !important; width: 100% !important; }

        #print-wrapper-proforma table.items { width: 100% !important; border-collapse: collapse !important; border: 1px solid #e2e8f0 !important; }
        #print-wrapper-proforma table.items th { background: #f1f5f9 !important; color: #334155 !important; padding: 12px 8px !important; border-bottom: 2px solid #cbd5e1 !important; font-size: 9pt !important; text-align: left !important; }
        #print-wrapper-proforma table.items td { padding: 10px 8px !important; border-bottom: 1px solid #f1f5f9 !important; font-size: 9.5pt !important; vertical-align: top !important; }
        #print-wrapper-proforma .col-qty { text-align: center !important; }
        #print-wrapper-proforma .col-unit, #print-wrapper-proforma .col-total { text-align: right !important; }
        
        #print-wrapper-proforma .totals { display: flex !important; justify-content: flex-end !important; margin-top: 20px !important; border-top: none !important; }
        #print-wrapper-proforma .totals-box { width: 300px !important; background: #f8fafc !important; padding: 15px !important; border: 1px solid #e2e8f0 !important; border-radius: 8px !important; }
      `:`
        #print-wrapper-proforma .brand { text-align: center !important; border-bottom: 1px dashed #333 !important; }
        #print-wrapper-proforma .meta p { display: flex !important; justify-content: space-between !important; }
      `}
    `,l=window.open("","_blank","width=900,height=700");l&&(l.document.write(`<html><head><title>PROFORMA - ${x.name}</title><style>${k}</style></head><body>${ee}</body></html>`),l.document.close(),l.focus(),l.onload=function(){setTimeout(()=>{l.print()},250)})},[x]),V=n.length<=2;return e.jsxs(Ie,{className:"no-print",children:[e.jsx(Fa,{}),e.jsxs(Me,{className:"no-print",style:{maxWidth:520,width:"96%",padding:"1.2rem",background:"#fff"},children:[e.jsxs(Pa,{children:[e.jsxs("h2",{style:{display:"flex",alignItems:"center",gap:8,margin:0},children:[e.jsx(Ht,{})," Vista Proforma"]}),e.jsxs("div",{style:{display:"flex",gap:8},children:[e.jsx(N,{onClick:()=>L("80"),children:"Ticket 80mm"}),e.jsxs(N,{onClick:()=>L("A4"),children:[e.jsx(Je,{})," A4"]}),e.jsx(N,{$cancel:!0,onClick:J,children:e.jsx(Ze,{})})]})]}),e.jsx(Ra,{children:e.jsxs(Aa,{id:"print-wrapper-proforma",className:`print-area print-80 ${V?"compact":""}`,children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"brand-logo-container",children:e.jsx(Oa,{className:"a4-logo",src:x.logo,alt:"Logo",onError:u=>{u.currentTarget.style.display="none"}})}),e.jsxs("div",{className:"brand-info",children:[e.jsx("h1",{children:x.name}),e.jsx("small",{children:x.slogan}),e.jsxs("small",{children:["RUC: ",x.ruc]}),e.jsxs("small",{children:["Tel: ",x.phone]}),e.jsx("small",{children:x.address}),e.jsx("div",{style:{marginTop:8},children:e.jsxs(Ma,{children:[e.jsx(Je,{})," PROFORMA"]})})]})]}),e.jsxs("div",{className:"meta",children:[e.jsxs("div",{className:"meta-col",children:[e.jsx("span",{className:"meta-title",children:"Detalles"}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Fecha:"}),e.jsx("span",{className:"meta-value",children:p})]}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"ID Temp:"}),e.jsx("span",{className:"meta-value",children:Date.now().toString().slice(-6)})]}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Atendido por:"}),e.jsx("span",{className:"meta-value",children:oe})]})]}),e.jsxs("div",{className:"meta-col",children:[e.jsx("span",{className:"meta-title",children:"Cliente"}),e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Nombre:"}),e.jsx("span",{className:"meta-value",children:O||j})]}),s&&e.jsxs("p",{children:[e.jsx("span",{className:"meta-label",children:"Cédula:"}),e.jsx("span",{className:"meta-value",children:s})]})]})]}),e.jsxs("table",{className:"items",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"col-qty",children:"Cant."}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{className:"text-right col-unit",children:"P. Unit."}),e.jsx("th",{className:"text-right col-total",children:"Total"})]})}),e.jsx("tbody",{children:n.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",style:{textAlign:"center",color:"#777"},children:"Sin ítems"})}):n.map((u,q)=>{const ee=Number(u.precio_venta??u.precio??0),k=Number(u.quantity??0),l=ee*k;return e.jsxs("tr",{children:[e.jsx("td",{className:"col-qty",children:k}),e.jsx("td",{children:u.nombre||u.descripcion||"Item"}),e.jsxs("td",{className:"text-right col-unit",children:["C$",y(ee)]}),e.jsxs("td",{className:"text-right col-total",children:["C$",y(l)]})]},q)})})]}),e.jsx("div",{className:"totals",children:e.jsxs("div",{className:"totals-box",children:[e.jsxs(ie,{children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["C$",y(r)]})]}),W>0&&e.jsxs(ie,{style:{color:"#dc3545"},children:[e.jsx("span",{children:"Descuento:"}),e.jsxs("span",{children:["- C$",y(W)]})]}),e.jsxs(ie,{className:"grand-total",style:{fontWeight:"bold",fontSize:"1.2rem",marginTop:5,borderTop:"2px solid black"},children:[e.jsx("span",{children:"TOTAL:"}),e.jsxs("span",{children:["C$",y(w)]})]}),e.jsxs("div",{style:{marginTop:12,textAlign:"center"},children:[e.jsx("span",{className:"badge",children:"DOCUMENTO NO VÁLIDO COMO FACTURA"}),e.jsx("p",{style:{margin:"5px 0 0",fontSize:"0.75rem",color:"#666"},children:"Precios sujetos a cambio. Válido por 3 días."})]})]})}),e.jsxs("div",{className:"thanks",children:[e.jsxs("p",{children:['"',x.slogan,'"']}),e.jsx("p",{style:{whiteSpace:"pre-line",marginTop:"5px"},children:(S==null?void 0:S.ticket_proforma_footer)||"¡Gracias por cotizar con nosotros!"})]})]})})]})]})},ke=({isOpen:n,onClose:w,onConfirm:r,onSubmit:W,title:O,message:J,fields:c=[],inputType:Q="number",icon:v})=>{const[S,_]=i.useState({}),[Y,oe]=i.useState("");if(i.useEffect(()=>{if(n)if(c.length>0){const p={};c.forEach(y=>{p[y.name]=y.defaultValue!==void 0?y.defaultValue:""}),_(p)}else oe("")},[n,c]),!n)return null;const j=()=>{c.length>0?W?W(S):r&&r(S):W?W(Y):r&&r(Y)},s=(p,y)=>{_(x=>({...x,[p]:y}))};return e.jsx(Ie,{children:e.jsxs(Me,{style:{maxWidth:"450px"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:"1.5rem"},children:[v?e.jsx("div",{style:{fontSize:"2.5rem",marginBottom:"1rem"},children:v}):e.jsx(Jt,{size:"2.5em",color:"#007bff"}),e.jsx("h2",{style:{marginTop:"0.5rem",marginBottom:"0.5rem"},children:O}),J&&e.jsx("p",{style:{color:"#6c757d"},children:J})]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem"},children:c.length>0?c.map(p=>e.jsxs("div",{children:[p.label&&e.jsx("label",{style:{display:"block",marginBottom:"5px",fontWeight:600,fontSize:"0.9rem"},children:p.label}),p.type==="select"?e.jsx("select",{value:S[p.name],onChange:y=>s(p.name,y.target.value),style:{width:"100%",padding:"10px",borderRadius:"8px",border:"1px solid #ccc",fontSize:"1rem"},children:p.options&&p.options.map(y=>e.jsx("option",{value:y.value,children:y.label},y.value))}):e.jsx(Z,{type:p.type||"text",placeholder:p.placeholder||"",value:S[p.name],onChange:y=>s(p.name,y.target.value),autoFocus:p.name===c[0].name})]},p.name)):e.jsx(Z,{type:Q,value:Y,onChange:p=>oe(p.target.value),autoFocus:!0})}),e.jsxs("div",{style:{display:"flex",justifyContent:"flex-end",gap:"1rem",marginTop:"2rem"},children:[e.jsx(N,{onClick:w,style:{backgroundColor:"#6c757d"},children:"Cancelar"}),e.jsx(N,{onClick:j,primary:!0,children:"Aceptar"})]})]})})},He=Ee.div`
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  padding: 8px;
  background: #f8f9fa;
  border-radius: 6px;
  
  label { font-weight: bold; color: #495057; }
  input { width: 120px; text-align: right; }
`,Ba=({isOpen:n,onClose:w,currentStats:r,onConfirm:W})=>{const[O,J]=i.useState("manual"),[c,Q]=i.useState({efectivo:"",credito:"",tarjeta:"",dolares:""}),[v,S]=i.useState({cordobas:"",dolares:""}),_=(j,s)=>{Q(p=>({...p,[j]:s}))},Y=(j,s)=>{S(p=>({...p,[j]:s}))},oe=()=>{const j=[];if(O==="manual")parseFloat(c.efectivo)&&j.push({target:"efectivo",amount:parseFloat(c.efectivo)}),parseFloat(c.credito)&&j.push({target:"credito",amount:parseFloat(c.credito)}),parseFloat(c.tarjeta)&&j.push({target:"tarjeta",amount:parseFloat(c.tarjeta)});else{const s=parseFloat(v.cordobas),p=parseFloat(v.dolares);if(!isNaN(s)){const y=Number((r==null?void 0:r.netCordobas)||0),x=s-y;Math.abs(x)>.01&&j.push({target:"efectivo",amount:x})}if(!isNaN(p)){const y=Number((r==null?void 0:r.netDolares)||0),x=p-y;Math.abs(x)>.01&&j.push({target:"dolares",amount:x})}}j.length>0&&W(j),w()};return n?e.jsx(Ie,{style:{background:"rgba(0,0,0,0.95)",zIndex:9999},children:e.jsxs(Me,{style:{maxWidth:"450px",background:"#212529",color:"#fff",border:"1px solid #495057"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20},children:[e.jsxs("h2",{style:{margin:0,color:"#ffc107",display:"flex",alignItems:"center",gap:10},children:[e.jsx(Qt,{})," GOD MODE"]}),e.jsx(N,{$cancel:!0,onClick:w,style:{background:"transparent",color:"#6c757d",border:"none"},children:"✕"})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginBottom:20},children:[e.jsx(N,{onClick:()=>J("manual"),style:{flex:1,background:O==="manual"?"#ffc107":"#343a40",color:O==="manual"?"#000":"#fff",border:"none"},children:"Ajuste Manual (+/-)"}),e.jsx(N,{onClick:()=>J("override"),style:{flex:1,background:O==="override"?"#ffc107":"#343a40",color:O==="override"?"#000":"#fff",border:"none"},children:"Fijar Monto (=)"})]}),O==="manual"?e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{color:"#adb5bd",fontSize:"0.85rem",marginBottom:15},children:"Suma o resta cantidades a los contadores ocultamente."}),e.jsxs(He,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Efectivo (C$)"}),e.jsx(Z,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:c.efectivo,onChange:j=>_("efectivo",j.target.value),style:{background:"#495057",color:"#fff"}})]}),e.jsxs(He,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Crédito"}),e.jsx(Z,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:c.credito,onChange:j=>_("credito",j.target.value),style:{background:"#495057",color:"#fff"}})]}),e.jsxs(He,{style:{background:"#343a40"},children:[e.jsx("label",{style:{color:"#fff"},children:"Tarjeta"}),e.jsx(Z,{type:"number",step:"0.01",placeholder:"+/- 0.00",value:c.tarjeta,onChange:j=>_("tarjeta",j.target.value),style:{background:"#495057",color:"#fff"}})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{style:{color:"#adb5bd",fontSize:"0.85rem",marginBottom:15},children:"Define EXACTAMENTE cuánto dinero físico hay. El sistema creará un ajuste mágico para cuadrar."}),e.jsxs("div",{style:{background:"#343a40",padding:10,borderRadius:6,marginBottom:10},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#aaa",marginBottom:5},children:[e.jsx("span",{children:"Sistema Actual:"}),e.jsxs("span",{children:["C$ ",Number((r==null?void 0:r.netCordobas)||0).toFixed(2)]})]}),e.jsxs(He,{style:{background:"transparent",padding:0,marginBottom:0},children:[e.jsx("label",{style:{color:"#fff"},children:"Real en Caja (C$)"}),e.jsx(Z,{type:"number",step:"0.01",placeholder:"0.00",value:v.cordobas,onChange:j=>Y("cordobas",j.target.value),style:{background:"#495057",color:"#fff",border:"1px solid #ffc107"}})]})]}),e.jsxs("div",{style:{background:"#343a40",padding:10,borderRadius:6},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",fontSize:"0.85rem",color:"#aaa",marginBottom:5},children:[e.jsx("span",{children:"Sistema Actual:"}),e.jsxs("span",{children:["$ ",Number((r==null?void 0:r.netDolares)||0).toFixed(2)]})]}),e.jsxs(He,{style:{background:"transparent",padding:0,marginBottom:0},children:[e.jsx("label",{style:{color:"#fff"},children:"Real en Caja ($)"}),e.jsx(Z,{type:"number",step:"0.01",placeholder:"0.00",value:v.dolares,onChange:j=>Y("dolares",j.target.value),style:{background:"#495057",color:"#fff",border:"1px solid #ffc107"}})]})]})]}),e.jsxs("div",{style:{marginTop:25,display:"flex",gap:10},children:[e.jsx(N,{onClick:w,style:{flex:1,background:"#495057",border:"none"},children:"Cancelar"}),e.jsxs(N,{onClick:oe,style:{flex:1,background:"#ffc107",color:"#000",fontWeight:"bold",border:"none"},children:[e.jsx(Yt,{style:{marginRight:6}})," ",O==="manual"?"APLICAR AJUSTE":"CUADRAR MÁGICAMENTE"]})]})]})}):null},ze=n=>Number(n||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Qa=()=>{var $e,Be,Le,Ve,at,ot,nt;const{user:n,products:w,token:r,refreshProducts:W,clients:O,allUsers:J}=tt(),{isCajaOpen:c,setIsCajaOpen:Q,cajaSession:v,setCajaSession:S,tasaDolar:_,setTasaDolar:Y,closeCajaSession:oe,refreshSession:j}=ha(),{orders:s,activeOrderId:p,setActiveOrderId:y,activeOrder:x,handleNewOrder:L,handleRemoveOrder:V,updateActiveOrder:u,loadOrdersFromDB:q,checkForNewOrders:ee}=ba(),k=(n==null?void 0:n.id_usuario)||(n==null?void 0:n.id),l=n,ve=(n==null?void 0:n.rol)==="admin",[be,je]=i.useState(w||[]),[we,De]=i.useState(""),[Qe,Ye]=i.useState("description"),[Fe,z]=i.useState(!1),[I,K]=i.useState({name:null,data:null}),[Se,te]=i.useState(null),[de,X]=i.useState({isOpen:!1,title:"",message:""}),[ae,ne]=i.useState({isOpen:!1,title:"",message:"",onConfirm:null}),[Te,ce]=i.useState(!1),H=i.useRef(null),pe=i.useMemo(()=>{if(!(v!=null&&v.transactions))return{netCordobas:0,netDolares:0};let t=0,a=0;const o=v.transactions,d=Number(v.initialAmount||0);t+=d;for(const b of o){const C=(b.type||"").toLowerCase();let m=b.pagoDetalles||{};if(typeof m=="string")try{m=JSON.parse(m)}catch{m={}}let B=Number(m.ingresoCaja!==void 0?m.ingresoCaja:b.amount||0);(C==="salida"||C.includes("devolucion"))&&(B=-Math.abs(B)),C.startsWith("venta")?m.efectivo!==void 0||m.dolares!==void 0?(t+=Number(m.efectivo||0)-Number(m.cambio||0),a+=Number(m.dolares||0)):t+=B-Number(m.tarjeta||0)-Number(m.transferencia||0)-Number(m.credito||0):C.includes("abono")?m.dolares!==void 0?(a+=Number(m.dolares||0),t+=Number(m.efectivo||0)):t+=B:C==="entrada"?t+=Math.abs(B):C==="salida"?t-=Math.abs(B):C==="ajuste"?(m.target==="efectivo"&&(t+=Number(b.amount||0)),m.target==="dolares"&&(a+=Number(b.amount||0))):t+=B}return{netCordobas:t,netDolares:a}},[v]),Pe=i.useCallback(()=>{try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;const a=new t,o=a.createOscillator(),d=a.createGain();o.connect(d),d.connect(a.destination),o.type="sine",o.frequency.setValueAtTime(1200,a.currentTime),d.gain.setValueAtTime(.1,a.currentTime),o.start(),o.stop(a.currentTime+.1)}catch{}},[]),F=(x==null?void 0:x.items)||[],se=F.reduce((t,a)=>t+a.precio_venta*a.quantity,0),E=(($e=x==null?void 0:x.discount)==null?void 0:$e.type)==="percentage"?se*x.discount.value/100:((Be=x==null?void 0:x.discount)==null?void 0:Be.value)||0,fe=se-E;i.useEffect(()=>{w&&je(w)},[w]),i.useEffect(()=>{if(k){q(k);const t=setInterval(()=>{document.hidden||ee(k)},15e3);return()=>clearInterval(t)}},[k,q,ee]);const T=({title:t,message:a})=>X({isOpen:!0,title:t,message:a}),Ae=()=>X({isOpen:!1}),g=({title:t,message:a,onConfirm:o})=>{ne({isOpen:!0,title:t,message:a,onConfirm:o})},M=()=>ne({isOpen:!1,title:"",message:"",onConfirm:null}),R=(t,a=null)=>K({name:t,data:a}),h=()=>K({name:null,data:null}),me=async()=>{try{await W(),k&&await q(k)}catch(t){console.error("Error refreshing data",t)}},re=t=>u("items",t),f=()=>{R("pinPrompt",{action:()=>ce(!0)})},U=async t=>{for(const a of t){const o={type:"ajuste",amount:a.amount,at:new Date().toISOString(),userId:k,note:`Ajuste Interno (${a.target})`,pagoDetalles:{target:a.target,hidden:!0,amount:a.amount,efectivo:a.target==="efectivo"?a.amount:0,dolares:a.target==="dolares"?a.amount:0,credito:a.target==="credito"?a.amount:0,tarjeta:a.target==="tarjeta"?a.amount:0},id:"ADJ-"+Date.now()+"-"+Math.random().toString(36).substr(2,5)};try{await Xe({userId:k,tx:o},r)}catch(d){console.error("Error saving secret adjust:",d)}}await j(),T({title:"Procesado",message:"Ajustes aplicados correctamente."})},ue=(t,a=1)=>{window.innerWidth<=960&&z(!0);const o=t.id_producto||t.id,d=F.find(D=>(D.id_producto||D.id)===o),b=((d==null?void 0:d.quantity)||0)+a;if(b>t.existencia){T({title:"Stock Insuficiente",message:`Solo hay ${t.existencia} unidades disponibles.`});return}Pe();const C=(d==null?void 0:d.precio_venta)||t.venta||t.precio||0,m={...t,id:o,id_producto:o,quantity:b,precio_venta:C},B=d?F.map(D=>(D.id_producto||D.id)===o?m:D):[...F,m];re(B)},G=(t,a)=>{var C;const o=t,d=be.find(m=>(m.id_producto||m.id)===o)||F.find(m=>(m.id_producto||m.id)===o);if(!d)return;let b=parseInt(a,10)||0;if(b<=0){re(F.filter(m=>(m.id_producto||m.id)!==o));return}b>(d.existencia||9999)&&(b=d.existencia,T({title:"Stock",message:"Cantidad máxima alcanzada según inventario."})),b>(((C=F.find(m=>(m.id_producto||m.id)===o))==null?void 0:C.quantity)||0)&&Pe(),re(F.map(m=>(m.id_producto||m.id)===o?{...m,quantity:b}:m))},Re=async t=>{var B;const a=p,o=s.find(D=>D.id===a);if(F.length===0)return T({title:"Carrito Vacío",message:"No hay productos para facturar."}),!1;const d=F.map(D=>({id_producto:D.id_producto||D.id,quantity:D.quantity,precio:D.precio_venta,nombre:D.nombre,codigo:D.codigo,costo:D.costo||0})),b={totalVenta:fe,subtotal:se,descuento:E,items:d,pagoDetalles:t,userId:k,clientId:Number(t.clienteId||0),tasaDolarAlMomento:_,originalOrderId:(o==null?void 0:o.serverSaleId)||null},C=!t.shouldPrintNow,m=async()=>{var D;try{const $=await va(b,r);W().catch(console.error);const xe=$.data||$||{},he={...b,...xe};if(he.id=xe.id||xe.saleId||xe._id||"N/A",he.items=d,he.pagoDetalles=t,he.fecha=new Date().toISOString(),t.shouldPrintNow&&te(he),c&&v){const Ce={...t};!Ce.tarjeta&&!Ce.transferencia&&!Ce.credito&&Ce.efectivo===void 0&&(Ce.efectivo=b.totalVenta);const Tt=((D=O.find(Ue=>Ue.id_cliente===Number(t.clienteId)))==null?void 0:D.nombre)||"Consumidor Final",kt=Number(b.totalVenta||0);Ce.efectivo=Number(Ce.efectivo||0);const it={type:"venta",amount:kt,at:new Date().toISOString(),userId:k,note:`Venta #${he.id} - ${Tt}`,pagoDetalles:Ce,id:he.id};if(Xe({userId:k,tx:it},r).catch(console.error),!C){const Ue={...v,transactions:[it,...v.transactions||[]]};S(Ue)}}}catch($){console.error("CRITICAL: Error saving sale in background:",$),T({title:"⚠️ Error de Sincronización",message:`La venta por C$ ${ze(fe)} NO se guardó en el servidor.
Error: ${$.message}.

Por favor, anote los detalles o reintente.`})}};if(C){if(V(a),je(D=>D.map($=>{const xe=d.find(he=>he.id_producto===($.id_producto||$.id));return xe?{...$,existencia:Math.max(0,$.existencia-xe.quantity)}:$})),c&&v){const D={...t},$=((B=O.find(rt=>rt.id_cliente===Number(t.clienteId)))==null?void 0:B.nombre)||"Consumidor Final",he={type:"venta",amount:Number(b.totalVenta||0),at:new Date().toISOString(),userId:k,note:`Venta (Pendiente) - ${$}`,pagoDetalles:D,id:"PEND-"+Date.now()},Ce={...v,transactions:[he,...v.transactions||[]]};S(Ce)}return T({title:"¡Éxito!",message:"Venta procesada."}),m(),!0}else return await m(),!0},Oe=async(t,a,o)=>{if(!a||a<=0){T({title:"Error",message:"Ingrese un monto válido"});return}const d={type:t,amount:parseFloat(a),note:o,at:new Date().toISOString(),userId:k};try{await Xe({userId:k,tx:d},r)}catch(b){console.error("Error saving manual tx:",b),T({title:"Error Servidor",message:"No se guardó en el servidor, pero se actualizará localmente."})}await j(),h(),T({title:"Éxito",message:t==="entrada"?"Entrada registrada":"Salida registrada"})},le=t=>{t&&t.trim()&&(u("name",t.trim()),h(),T({title:"Ticket Renombrado",message:`Nombre actualizado a: ${t.trim()} `}))},P=t=>{var m,B;const a=(m=I.data)==null?void 0:m.item;if(!a)return;const o=parseFloat(t),d=a.costo||((B=a.raw)==null?void 0:B.costo)||0;if(o<d){T({title:"Precio Inválido",message:`El precio C$${o.toFixed(2)} es menor al costo(C$${d.toFixed(2)}).`});return}const b=a.id_producto||a.id,C=F.map(D=>(D.id_producto||D.id)===b?{...D,precio_venta:o}:D);re(C),h()},A=t=>{const a=t.id_producto||t.id,o=be.find($=>($.id_producto||$.id)===a)||t,d=Number(o.mayorista||o.mayoreo||0);if(!d){T({title:"Aviso",message:"Este producto no tiene precio mayorista."});return}const b=Number(t.precio_venta||0),C=Math.abs(b-d)<.01,m=Number(o.venta||o.precio||(C?t.originalPrice:t.precio_venta)||0),B=C?m:d,D=F.map($=>($.id_producto||$.id)===a?{...$,precio_venta:B}:$);re(D),T(C?{title:"Precio Revertido",message:"Se ha restablecido el precio regular."}:{title:"Precio Mayorista",message:"✅ ACTIVADO Precio Mayorista"})},We=(t,a)=>{var D,$;const o=(D=I.data)==null?void 0:D.item;if(!o)return;const d=o.id_producto||o.id;let b=o.precio_venta;const C=parseFloat(t);if(isNaN(C)||C<0){T({title:"Valor Inválido",message:"Ingrese un valor de descuento válido."});return}a==="percentage"?b=b-b*(C/100):b=b-C;const m=o.costo||(($=o.raw)==null?void 0:$.costo)||0;if(b<m){T({title:"Precio Inválido",message:`El descuento deja el precio(C$${b.toFixed(2)}) por debajo del costo.`});return}const B=F.map(xe=>(xe.id_producto||xe.id)===d?{...xe,precio_venta:b}:xe);re(B),h()},Ne=i.useMemo(()=>{const t=new Map;return s.forEach(a=>{a.id!==(x==null?void 0:x.id)&&a.items.forEach(o=>{const d=o.id_producto||o.id,b=Number(o.cantidad||o.quantity||0);t.set(d,(t.get(d)||0)+b)})}),t},[s,x]),ge=()=>{let t=0;const a=F.map(o=>{const d=be.find($=>($.id_producto||$.id)===(o.id_producto||o.id));if(!d)return o;const b=Number(d.mayorista||d.mayoreo||0);if(!b)return o;const C=Number(o.precio_venta||0),m=Math.abs(C-b)<.01,B=Number(d.venta||d.precio||o.originalPrice||o.precio_venta||0),D=m?B:b;return Math.abs(C-D)>.01?(t++,{...o,precio_venta:D}):o});if(t>0){re(a);const o=a.find((C,m)=>{var B;return Math.abs(C.precio_venta-(((B=F[m])==null?void 0:B.precio_venta)||0))>.01}),d=be.find(C=>(C.id_producto||C.id)===((o==null?void 0:o.id_producto)||(o==null?void 0:o.id))),b=d&&Math.abs(o.precio_venta-Number(d.mayorista||0))<.01;T({title:"Precio Actualizado",message:`${b?"ACTIVADO":"DESACTIVADO"} precio mayorista en ${t} producto(s).`})}else T({title:"Sin Cambios",message:"No hay productos con precio mayorista disponible o ya están aplicados."})},ye=t=>{u("discount",t),h()};return c?e.jsxs(xt,{children:[e.jsxs(da,{children:[e.jsxs(ca,{to:"/dashboard",children:[e.jsx(Kt,{})," Regresar"]}),e.jsx("div",{style:{fontWeight:"800",letterSpacing:"1px",userSelect:"none"},onDoubleClick:f,children:"SISTEMA POS"}),e.jsxs("div",{className:"right-actions",children:[e.jsx(N,{secondary:!0,onClick:me,title:"Sincronizar",children:e.jsx(Xt,{})}),e.jsx(N,{secondary:!0,onClick:()=>R("salesHistory"),title:"Historial de Ventas",children:e.jsx(Zt,{})}),e.jsx(N,{secondary:!0,onClick:()=>R("cashEntry"),title:"Entrada de Dinero",children:e.jsx(ea,{color:"#10b981"})}),e.jsx(N,{secondary:!0,onClick:()=>R("cashExit"),title:"Salida de Dinero",children:e.jsx(ta,{color:"#ef4444"})}),e.jsxs(N,{secondary:!0,onClick:()=>R("caja"),children:[e.jsx(Ke,{})," ",(l==null?void 0:l.nombre_usuario)||"Caja"]})]})]}),e.jsxs(pa,{children:[e.jsx(wt,{children:e.jsx(ka,{products:be,searchTerm:we,setSearchTerm:De,searchType:Qe,setSearchType:Ye,onProductClick:t=>ue(t,1),cartItems:F,inputRef:H,reservedStock:Ne})}),e.jsx(ma,{isOpen:Fe,children:e.jsxs("div",{style:{padding:"1.2rem",display:"flex",flexDirection:"column",height:"100%"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginBottom:"1rem"},children:[e.jsxs("h3",{style:{margin:0,display:"flex",alignItems:"center",gap:"8px"},children:[e.jsx(aa,{color:"#2563eb"})," Carrito"]}),window.innerWidth<=960&&e.jsx(N,{onClick:()=>z(!1),children:e.jsx(Ct,{})})]}),e.jsxs(xa,{children:[s.map(t=>e.jsxs(N,{primary:t.id===p,secondary:t.id!==p,onClick:()=>y(t.id),onDoubleClick:()=>R("renameTicket"),style:{fontSize:"0.75rem",padding:"6px 10px",display:"flex",alignItems:"center",gap:"5px"},children:[t.name,e.jsx("span",{style:{marginLeft:5,fontWeight:"bold",cursor:"pointer"},onClick:a=>{a.stopPropagation(),V(t.id)},children:"×"})]},t.id)),e.jsx(N,{secondary:!0,onClick:L,title:"Nuevo Ticket",children:e.jsx(dt,{})})]}),e.jsxs("div",{style:{display:"flex",gap:"6px",marginTop:"0.75rem",flexWrap:"wrap"},children:[e.jsxs(N,{secondary:!0,onClick:ge,title:"Cambiar a Precio Mayorista",disabled:F.length===0,style:{flex:1,fontSize:"0.75rem",padding:"8px",display:"flex",alignItems:"center",gap:"4px",justifyContent:"center"},children:[e.jsx(ct,{size:12})," Mayorista"]}),e.jsxs(N,{secondary:!0,onClick:()=>R("discount"),title:"Aplicar Descuento",disabled:F.length===0,style:{flex:1,fontSize:"0.75rem",padding:"8px",display:"flex",alignItems:"center",gap:"4px",justifyContent:"center"},children:[e.jsx(Ge,{size:12})," Descuento"]})]}),e.jsx("div",{style:{flex:1,overflowY:"auto",margin:"1rem 0",paddingRight:"5px"},children:F.length===0?e.jsx("div",{style:{textAlign:"center",color:"#94a3b8",marginTop:"2rem"},children:"Selecciona productos para vender"}):F.map(t=>e.jsxs(fa,{children:[e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:600,fontSize:"0.85rem",color:"#1e293b"},children:t.nombre}),e.jsx("div",{style:{fontSize:"0.85rem",fontWeight:"bold",color:"#334155",fontStyle:"normal"},children:t.codigo}),e.jsxs("div",{style:{fontSize:"0.8rem",color:"#64748b"},children:["Unit: C$ ",ze(t.precio_venta)]}),e.jsxs("div",{style:{fontSize:"0.85rem",fontWeight:"700",color:"#2563eb",marginTop:"2px"},children:["Total: C$ ",ze(Number(t.quantity||1)*Number(t.precio_venta||0))]}),e.jsxs("div",{style:{display:"flex",gap:"8px",marginTop:"6px"},children:[e.jsx(_e,{title:"Editar Precio",onClick:()=>R("editPrice",{item:t}),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(pt,{size:10})}),e.jsx(_e,{title:"Precio Mayorista",onClick:()=>A(t),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(ct,{size:10})}),e.jsx(_e,{title:"Descuento Item",onClick:()=>R("itemDiscount",{item:t}),style:{width:26,height:26,background:"#f1f5f9",color:"#334155"},children:e.jsx(Ge,{size:10})})]})]}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsxs(ua,{children:[e.jsx(_e,{onClick:()=>G(t.id_producto||t.id,t.quantity-1),children:e.jsx(oa,{size:8})}),e.jsx("span",{style:{fontWeight:700,minWidth:24,textAlign:"center",fontSize:"0.9rem"},children:t.quantity}),e.jsx(_e,{onClick:()=>G(t.id_producto||t.id,t.quantity+1),children:e.jsx(dt,{size:8})})]}),e.jsx(_e,{onClick:()=>re(F.filter(a=>(a.id_producto||a.id)!==(t.id_producto||t.id))),style:{color:"#ef4444"},children:e.jsx(na,{size:12})})]})]},t.id_producto||t.id))}),e.jsxs("div",{style:{borderTop:"2px solid #f1f5f9",paddingTop:"1rem"},children:[e.jsxs(ie,{children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["C$ ",ze(se)]})]}),e.jsxs(ie,{style:{color:"#ef4444"},children:[e.jsx("span",{children:"Descuento"}),e.jsxs("span",{children:["- C$ ",ze(E)]})]}),e.jsxs(ie,{className:"grand-total",style:{fontSize:"1.4rem",marginTop:"5px"},children:[e.jsx("span",{children:"TOTAL"}),e.jsxs("span",{children:["C$ ",ze(fe)]})]}),e.jsxs(N,{secondary:!0,style:{width:"100%",marginTop:"1rem",padding:"10px",fontSize:"0.9rem",display:"flex",alignItems:"center",gap:"6px",justifyContent:"center"},onClick:()=>R("proformaName"),children:[e.jsx(Je,{})," Crear Proforma"]}),e.jsx(N,{primary:!0,style:{width:"100%",marginTop:"12px",padding:"16px",fontSize:"1.2rem",fontWeight:"bold"},onClick:()=>R("payment",{total:fe}),disabled:F.length===0,children:"$ COBRAR (F2)"})]})]})}),e.jsxs(ft,{onClick:()=>z(!0),children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[e.jsx("div",{style:{background:"#3b82f6",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"0.8rem"},children:F.reduce((t,a)=>t+(a.quantity||0),0)}),e.jsx("span",{children:"Ver Venta"})]}),e.jsxs("span",{children:["C$ ",ze(fe)]})]})]}),e.jsxs(yt,{children:[de.isOpen&&e.jsx(Ie,{onClick:Ae,children:e.jsxs(Me,{onClick:t=>t.stopPropagation(),style:{maxWidth:"380px",textAlign:"center"},children:[e.jsx("h2",{style:{marginTop:0},children:de.title}),e.jsx("p",{style:{color:"#475569"},children:de.message}),e.jsx(N,{primary:!0,onClick:Ae,style:{width:"100%",marginTop:"1rem"},children:"Entendido"})]})}),ae.isOpen&&e.jsx(Ie,{onClick:M,children:e.jsxs(Me,{onClick:t=>t.stopPropagation(),style:{maxWidth:"380px",textAlign:"center"},children:[e.jsx("h2",{style:{marginTop:0},children:ae.title}),e.jsx("p",{style:{color:"#475569"},children:ae.message}),e.jsxs("div",{style:{display:"flex",gap:"10px",marginTop:"1rem"},children:[e.jsx(N,{onClick:M,style:{flex:1},children:"Cancelar"}),e.jsx(N,{primary:!0,onClick:()=>{var t;(t=ae.onConfirm)==null||t.call(ae),M()},style:{flex:1},children:"Confirmar"})]})]})}),I.name==="payment"&&e.jsx(Da,{isOpen:!0,onClose:h,total:I.data.total,onFinishSale:Re,tasaDolar:_,clientes:O||[],showAlert:T}),I.name==="caja"&&e.jsx(jt,{isOpen:!0,onClose:h,currentUser:l,isCajaOpen:c,session:v,isAdmin:ve,clients:O||[],showAlert:T,showConfirmation:g,initialTasaDolar:_,onOpenCaja:async(t,a)=>{try{const o=await gt({userId:k,openedAt:new Date().toISOString(),openedBy:{id:k,name:l==null?void 0:l.nombre_usuario},initialAmount:t,tasaDolar:a},r);await j(),h()}catch{T({title:"Error",message:"No se pudo abrir la caja en el servidor."})}},onCloseCaja:async t=>{try{await ut({userId:k,closedAt:new Date().toISOString(),closedBy:{id:k,name:l==null?void 0:l.nombre_usuario},countedAmount:t,notes:"Cierre desde POS"},r),await j(),h(),T({title:"Caja Cerrada",message:"La sesión se ha cerrado y guardado correctamente."})}catch(a){console.error(a),T({title:"Error",message:"Error cerrando caja en servidor."})}}}),I.name==="salesHistory"&&e.jsx(Sa,{isOpen:!0,onClose:h,dailySales:[],loadSales:async t=>{try{return await Ca(r,t)||[]}catch(a){return console.error("Error loading sales:",a),[]}},isAdmin:ve,users:J,clients:O||[],onReprintTicket:t=>{te(t)},onCancelSale:async t=>{try{const a=(t==null?void 0:t.id)||t;if(await ya(a,r),T({title:"Venta Cancelada",message:`La venta #${a} ha sido cancelada exitosamente.`}),c&&v&&typeof t=="object"){let o=typeof t.pagoDetalles=="string"?JSON.parse(t.pagoDetalles||"{}"):t.pagoDetalles||{},d=Number(o.ingresoCaja||0);!d&&o.efectivo&&(d=Number(o.efectivo));const b=o.credito>0;if(d===0&&!b&&t.totalVenta&&(d=Number(t.totalVenta)),d>0){const C={type:"cancelacion",amount:-d,at:new Date().toISOString(),userId:k,userName:(l==null?void 0:l.nombre_usuario)||"Caja",note:`Cancelación Venta #${a}`,pagoDetalles:{efectivo:d,ingresoCaja:-d},id:"CANCEL-"+Date.now()},m={...v,transactions:[C,...v.transactions||[]]};S(m),console.log("Caja actualizada por cancelación:",C)}}}catch(a){throw console.error("Cancel error:",a),T({title:"Error",message:"No se pudo cancelar la venta: "+(a.message||"Error desconocido")}),a}},onReturnItem:async(t,a,o)=>{try{const d={originalSaleId:t.id,item:a,quantity:o,userId:k};await ja(d,r);const C=(a.precio||a.precio_venta||0)*o;if(c&&v){const m={type:"devolucion",amount:-C,at:new Date().toISOString(),userId:k,userName:(l==null?void 0:l.nombre_usuario)||"Caja",note:`Devolución: ${o}x ${a.nombre}`,pagoDetalles:{efectivo:C,ingresoCaja:-C},id:"REFUND-"+Date.now()},B={...v,transactions:[m,...v.transactions||[]]};S(B),T({title:"Devolución Exitosa",message:`Devolución registrada en sistema y C$${C.toFixed(2)} descontados de caja.`})}else T({title:"Devolución Exitosa (Caja Cerrada)",message:"Devolución registrada, pero NO se descontó de caja porque está cerrada."})}catch(d){throw console.error("Return error:",d),T({title:"Error",message:"Error al procesar devolución: "+(d.message||"Error desconocido")}),d}},onAbonoSuccess:()=>{console.log("Abono success")}}),Se&&e.jsx(Na,{isOpen:!0,transaction:Se,onClose:()=>te(null),clients:O,users:[n],currentUser:n}),I.name==="proformaName"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Datos de Proforma",fields:[{name:"name",label:"A nombre de:",type:"text",placeholder:"Nombre del Cliente (Opcional)"}],onSubmit:t=>{h(),setTimeout(()=>R("proforma",{proformaFor:t.name}),200)},icon:e.jsx(Je,{color:"#0b72b9"})}),I.name==="proforma"&&e.jsx($a,{isOpen:!0,onClose:h,cart:F,total:fe,subtotal:se,discount:E,proformaFor:(Le=I.data)==null?void 0:Le.proformaFor,currentUser:l}),I.name==="cashEntry"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Entrada de Dinero",fields:[{name:"amount",label:"Monto (C$)",type:"number",placeholder:"0.00"},{name:"note",label:"Motivo",type:"text",placeholder:"Descripción de la entrada"}],onSubmit:t=>Oe("entrada",t.amount,t.note),icon:e.jsx(et,{color:"#10b981"})}),I.name==="cashExit"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Salida de Dinero",fields:[{name:"amount",label:"Monto (C$)",type:"number",placeholder:"0.00"},{name:"note",label:"Motivo",type:"text",placeholder:"Descripción de la salida"}],onSubmit:t=>Oe("salida",t.amount,t.note),icon:e.jsx(et,{color:"#ef4444"})}),I.name==="renameTicket"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Renombrar Ticket",fields:[{name:"name",label:"Nuevo Nombre",type:"text",defaultValue:(x==null?void 0:x.name)||"Ticket"}],onSubmit:t=>le(t.name),icon:e.jsx(ra,{color:"#2563eb"})}),I.name==="editPrice"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Editar Precio",fields:[{name:"price",label:`Nuevo Precio(C$)[Costo: C$${(((at=(Ve=I.data)==null?void 0:Ve.item)==null?void 0:at.costo)||0).toFixed(2)}]`,type:"number",defaultValue:(nt=(ot=I.data)==null?void 0:ot.item)==null?void 0:nt.precio_venta}],onSubmit:t=>P(t.price),icon:e.jsx(pt,{color:"#f59e0b"})}),I.name==="itemDiscount"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Descuento al Producto",fields:[{name:"type",label:"Tipo",type:"select",options:[{value:"fixed",label:"Monto Fijo (C$)"},{value:"percentage",label:"Porcentaje (%)"}],defaultValue:"fixed"},{name:"value",label:"Valor",type:"number",placeholder:"0.00"}],onSubmit:t=>We(t.value,t.type),icon:e.jsx(Ge,{color:"#2563eb"})}),I.name==="discount"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Aplicar Descuento",fields:[{name:"type",label:"Tipo",type:"select",options:[{value:"fixed",label:"Monto Fijo (C$)"},{value:"percentage",label:"Porcentaje (%)"}],defaultValue:"fixed"},{name:"value",label:"Valor",type:"number",placeholder:"0.00"}],onSubmit:t=>{const a={type:t.type,value:parseFloat(t.value)||0};ye(a)},icon:e.jsx(Ge,{color:"#2563eb"})}),e.jsx(wa,{isOpen:ae.isOpen,onClose:M,title:ae.title,message:ae.message,onConfirm:()=>{ae.onConfirm&&ae.onConfirm(),M()}}),I.name==="pinPrompt"&&e.jsx(ke,{isOpen:!0,onClose:h,title:"Acceso Restringido",fields:[{name:"pin",label:"PIN de Seguridad",type:"password",autoFocus:!0}],onSubmit:t=>{var a,o;t.pin==="111987"?(h(),(o=(a=I.data)==null?void 0:a.action)==null||o.call(a)):T({title:"Error",message:"PIN Incorrecto"})},icon:e.jsx(Ke,{color:"#dc3545"})}),Te&&e.jsx(Ba,{isOpen:!0,onClose:()=>ce(!1),session:v,currentStats:pe,onConfirm:U})]}),e.jsxs(ft,{onClick:()=>z(!0),children:[e.jsxs("span",{children:["🛒 Carrito (",F.length,")"]}),e.jsxs("span",{style:{fontWeight:"bold"},children:["C$ ",ze(fe)]})]})]}):e.jsxs(xt,{style:{alignItems:"center",justifyContent:"center",textAlign:"center"},children:[e.jsx(Ke,{size:50,color:"#cbd5e1",style:{marginBottom:"1rem"}}),e.jsx("h1",{style:{color:"#64748b",margin:"0 0 0.5rem 0"},children:"Caja Cerrada"}),e.jsx("p",{style:{color:"#94a3b8",marginBottom:"1.5rem"},children:"Debes realizar la apertura de caja para procesar ventas."}),e.jsxs(N,{primary:!0,onClick:()=>R("caja"),children:[e.jsx(Ut,{})," Abrir Caja (F9)"]}),I.name==="caja"&&e.jsx(jt,{isOpen:!0,onClose:h,currentUser:l,isCajaOpen:c,session:v,isAdmin:ve,showAlert:T,showConfirmation:g,initialTasaDolar:_,onOpenCaja:async(t,a)=>{try{const o=await gt({userId:k,openedAt:new Date().toISOString(),openedBy:{id:k,name:(l==null?void 0:l.nombre)||(l==null?void 0:l.nombre_usuario)},initialAmount:t,tasaDolar:a},r);await j(),h()}catch{T({title:"Error",message:"No se pudo abrir la caja en el servidor."})}},onCloseCaja:async t=>{try{const a=await ut({userId:k,closedAt:new Date().toISOString(),closedBy:{id:k,name:(l==null?void 0:l.nombre)||(l==null?void 0:l.nombre_usuario)},countedAmount:t,notes:"Cierre desde POS"},r);await j(),h(),T({title:"Caja Cerrada",message:"La sesión se ha cerrado y guardado correctamente."})}catch(a){console.error(a),T({title:"Error",message:"Error cerrando caja en servidor: "+(a.message||"Desconocido")})}}})]})};export{Qa as default};
